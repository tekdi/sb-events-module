/**
 * @fileoverview added by tsickle
 * Generated from: lib/topicpicker/topicpicker.component.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, EventEmitter, Input, Output } from '@angular/core';
import { Subject, merge } from 'rxjs';
import * as _ from 'lodash-es';
import { FormControl, FormGroup } from '@angular/forms';
import { tap, takeUntil } from 'rxjs/operators';
/**
 * @record
 */
function TopicTreeNode() { }
if (false) {
    /** @type {?} */
    TopicTreeNode.prototype.id;
    /** @type {?} */
    TopicTreeNode.prototype.name;
    /** @type {?} */
    TopicTreeNode.prototype.selectable;
    /** @type {?} */
    TopicTreeNode.prototype.nodes;
}
/**
 * @record
 */
function JQuery() { }
if (false) {
    /**
     * @param {?=} options
     * @return {?}
     */
    JQuery.prototype.treePicker = function (options) { };
}
export class TopicpickerComponent {
    constructor() {
        this.topicChange = new EventEmitter();
        this.dependencyTerms = [];
        this.dispose$ = new Subject();
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.formControlRef.valueChanges.pipe(tap((/**
         * @param {?} val
         * @return {?}
         */
        val => {
            console.log(val);
        })), takeUntil(this.dispose$)).subscribe();
        /** @type {?} */
        const selectedTopics = _.reduce(this.default, (/**
         * @param {?} collector
         * @param {?} element
         * @return {?}
         */
        (collector, element) => {
            if (typeof element === 'string') {
                collector.unformatted.push(element);
            }
            else if (_.get(element, 'identifier')) {
                collector.formatted.push(element);
            }
            return collector;
        }), { formatted: [], unformatted: [] });
        this.formatSelectedTopics(this.field.terms, selectedTopics.unformatted, selectedTopics.formatted);
        this.default = selectedTopics.unformatted;
        this.selectedNodes = Object.assign({}, selectedTopics.formatted);
        this.topicChange.emit(this.selectedTopics);
        if (!_.isEmpty(this.default)) {
            this.placeHolder = this.default && this.default.length + ' topics selected';
            this.formControlRef.setValue(this.default);
        }
        if (!_.isEmpty(this.depends)) {
            merge(..._.map(this.depends, (/**
             * @param {?} depend
             * @return {?}
             */
            depend => depend.valueChanges))).pipe(tap((/**
             * @param {?} value
             * @return {?}
             */
            (value) => {
                this.latestParentValue = value;
                this.isDependsInvalid = _.includes(_.map(this.depends, (/**
                 * @param {?} depend
                 * @return {?}
                 */
                depend => depend.invalid)), true);
                this.formControlRef.patchValue(null);
                this.placeHolder = '';
                this.default = [];
                this.selectedNodes = {};
                this.initTopicPicker(this.formatTopics(this.fetchAssociations()));
            })), takeUntil(this.dispose$)).subscribe();
            this.isDependsInvalid = _.includes(_.map(this.depends, (/**
             * @param {?} depend
             * @return {?}
             */
            depend => depend.invalid)), true);
        }
    }
    // tslint:disable-next-line:use-life-cycle-interface
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        this.initTopicPicker(this.formatTopics(this.field.terms));
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.dispose$.next(null);
        this.dispose$.complete();
    }
    /**
     * @private
     * @param {?} topics
     * @param {?=} subTopic
     * @return {?}
     */
    formatTopics(topics, subTopic = false) {
        return _.map(topics, (/**
         * @param {?} topic
         * @return {?}
         */
        (topic) => ({
            id: topic.identifier,
            name: topic.name,
            selectable: subTopic ? 'selectable' : 'notselectable',
            nodes: this.formatTopics(topic.children, true)
        })));
    }
    /**
     * @private
     * @param {?} topics
     * @param {?} unformatted
     * @param {?} formatted
     * @return {?}
     */
    formatSelectedTopics(topics, unformatted, formatted) {
        _.forEach(topics, (/**
         * @param {?} topic
         * @return {?}
         */
        (topic) => {
            if (unformatted.includes(this.field.output ? topic[this.field.output] : topic.name) && !topic.children) {
                formatted.push({
                    identifier: topic.identifier,
                    name: topic.name
                });
            }
            if (topic.children) {
                this.formatSelectedTopics(topic.children, unformatted, formatted);
            }
        }));
    }
    /**
     * @private
     * @param {?} data
     * @return {?}
     */
    initTopicPicker(data) {
        $(`.topic-picker-selector_${this.field.code}`).treePicker({
            data: data,
            name: 'Topics',
            noDataMessage: 'noDataMessage',
            submitButtonText: 'Done',
            cancelButtonText: 'Cancel',
            removeAllText: 'Remove All',
            chooseAllText: 'Choose All',
            searchText: 'Search',
            selectedText: 'selected',
            picked: (!_.isEmpty(this.selectedNodes)) ? _.map(this.selectedNodes, 'identifier') : (!_.isEmpty(this.default) ? this.default : []),
            onSubmit: (/**
             * @param {?} selectedNodes
             * @return {?}
             */
            (selectedNodes) => {
                this.selectedNodes = selectedNodes;
                this.selectedTopics = _.map(selectedNodes, (/**
                 * @param {?} node
                 * @return {?}
                 */
                node => ({
                    identifier: node.id,
                    name: node.name
                })));
                this.placeHolder = this.selectedTopics.length + ' topics selected';
                this.topicChange.emit(this.selectedTopics);
                /** @type {?} */
                const topics = [];
                _.forEach(this.selectedTopics, (/**
                 * @param {?} value
                 * @param {?} index
                 * @return {?}
                 */
                (value, index) => {
                    if (this.field.output) {
                        topics.push(value[this.field.output]);
                    }
                    else {
                        topics.push(value.name);
                    }
                }));
                this.formControlRef.setValue(topics);
            }),
            nodeName: `topicSelector_${this.field.code}`,
            displayFormat: (/**
             * @param {?} picked
             * @return {?}
             */
            function (picked) { return this.placeHolder; }),
            minSearchQueryLength: 1,
            disabled: (/**
             * @param {?} node
             * @return {?}
             */
            (node) => {
                return this.disabled ? true : (this.depends ? (this.isDependsInvalid ? true : false) : false);
            })
        });
        setTimeout((/**
         * @return {?}
         */
        () => document.getElementById(`topicSelector_${this.field.code}`).classList.add(this.topicPickerClass)), 0);
    }
    /**
     * @return {?}
     */
    fetchAssociations() {
        // && this.context.value && this.field.association
        if (!_.isEmpty(this.depends)) {
            /** @type {?} */
            const filteredTerm = _.find(this.dependencyTerms, (/**
             * @param {?} terms
             * @return {?}
             */
            terms => {
                return !_.isEmpty(this.field.output) ? _.includes(this.getParentValue(), terms[this.field.output]) :
                    _.includes(this.getParentValue(), terms.name);
            }));
            if (filteredTerm) {
                this.tempAssociation = _.filter(filteredTerm.associations, (/**
                 * @param {?} association
                 * @return {?}
                 */
                association => {
                    return (this.field.sourceCategory) ? (association.category === this.field.sourceCategory) :
                        association.category === this.field.code;
                }));
                return this.tempAssociation;
            }
            else {
                return this.field.terms;
            }
        }
        else {
            return this.field.terms;
        }
    }
    /**
     * @return {?}
     */
    getParentValue() {
        return this.latestParentValue || _.compact(_.map(this.depends, 'value'));
    }
}
TopicpickerComponent.decorators = [
    { type: Component, args: [{
                selector: 'sb-topicpicker',
                template: "<div class=\"treepicker-parent\">\n  <label *ngIf=\"label\">{{label}}</label>\n  <div [attr.disabled]=\"disabled ? true : ( depends ? (isDependsInvalid ? true : null) : null )\" id=\"treePicker\" class=\"topic-picker-selector_{{field.code}} cursor-pointer list-border\">\n  {{placeHolder}}\n  </div>\n\n  <input [attr.disabled]=\"disabled ? true : ( depends ? (isDependsInvalid ? true : null) : null )\" [formControl]=\"formControlRef\" [placeholder]=\"placeHolder\" readonly hidden/>\n  <ng-container *ngFor=\"let validation of validations\">\n    <div class=\"cf-error\"\n      *ngIf=\"(validation.type && (validation.type).toLowerCase() && validation.message && formControlRef.errors && formControlRef.errors[(validation.type).toLowerCase()] && (formControlRef.dirty || formControlRef.touched))\">\n      {{ validation.message }}\n    </div>\n  </ng-container>\n</div>\n",
                styles: [".treepicker-parent{margin:1rem 0}label{display:block;font-size:1rem;margin:0}.topic-picker-selector{width:100%;padding:8px 16px;border:.5px solid #333;box-sizing:border-box}.cf-error{color:red;font-family:\"Noto Sans\";font-size:12px}.treepicker-parent .list-border{border:.5px solid var(--gray-400);padding:1.3rem;cursor:pointer;display:-webkit-box;display:flex;-webkit-box-align:center;align-items:center;left:0;height:40px}"]
            }] }
];
/** @nocollapse */
TopicpickerComponent.ctorParameters = () => [];
TopicpickerComponent.propDecorators = {
    selectedTopics: [{ type: Input }],
    topicPickerClass: [{ type: Input }],
    label: [{ type: Input }],
    disabled: [{ type: Input }],
    placeholder: [{ type: Input }],
    formControlRef: [{ type: Input }],
    field: [{ type: Input }],
    topicChange: [{ type: Output }],
    validations: [{ type: Input }],
    formGroup: [{ type: Input }],
    default: [{ type: Input }],
    depends: [{ type: Input }],
    dependencyTerms: [{ type: Input }]
};
if (false) {
    /** @type {?} */
    TopicpickerComponent.prototype.selectedTopics;
    /** @type {?} */
    TopicpickerComponent.prototype.topicPickerClass;
    /** @type {?} */
    TopicpickerComponent.prototype.label;
    /** @type {?} */
    TopicpickerComponent.prototype.disabled;
    /** @type {?} */
    TopicpickerComponent.prototype.placeholder;
    /** @type {?} */
    TopicpickerComponent.prototype.formControlRef;
    /** @type {?} */
    TopicpickerComponent.prototype.field;
    /** @type {?} */
    TopicpickerComponent.prototype.topicChange;
    /** @type {?} */
    TopicpickerComponent.prototype.validations;
    /** @type {?} */
    TopicpickerComponent.prototype.formGroup;
    /** @type {?} */
    TopicpickerComponent.prototype.default;
    /** @type {?} */
    TopicpickerComponent.prototype.depends;
    /** @type {?} */
    TopicpickerComponent.prototype.dependencyTerms;
    /** @type {?} */
    TopicpickerComponent.prototype.selectedNodes;
    /** @type {?} */
    TopicpickerComponent.prototype.placeHolder;
    /** @type {?} */
    TopicpickerComponent.prototype.isDependsInvalid;
    /**
     * @type {?}
     * @private
     */
    TopicpickerComponent.prototype.dispose$;
    /** @type {?} */
    TopicpickerComponent.prototype.latestParentValue;
    /** @type {?} */
    TopicpickerComponent.prototype.tempAssociation;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9waWNwaWNrZXIuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vY29tbW9uLWZvcm0tZWxlbWVudHMvIiwic291cmNlcyI6WyJsaWIvdG9waWNwaWNrZXIvdG9waWNwaWNrZXIuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFxQixNQUFNLEVBQWlCLE1BQU0sZUFBZSxDQUFDO0FBQ3pHLE9BQU8sRUFBK0IsT0FBTyxFQUFFLEtBQUssRUFBUSxNQUFNLE1BQU0sQ0FBQztBQUN6RSxPQUFPLEtBQUssQ0FBQyxNQUFNLFdBQVcsQ0FBQztBQUMvQixPQUFPLEVBQUUsV0FBVyxFQUFHLFNBQVMsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBRXhELE9BQU8sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7Ozs7QUFJaEQsNEJBS0M7OztJQUpDLDJCQUFXOztJQUNYLDZCQUFhOztJQUNiLG1DQUFtQjs7SUFDbkIsOEJBQTRCOzs7OztBQUU5QixxQkFFQzs7Ozs7O0lBREMscURBQTBCOztBQVM1QixNQUFNLE9BQU8sb0JBQW9CO0lBd0IvQjtRQWZVLGdCQUFXLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQU1sQyxvQkFBZSxHQUFTLEVBQUUsQ0FBQztRQUs1QixhQUFRLEdBQUcsSUFBSSxPQUFPLEVBQWEsQ0FBQztJQUk1QixDQUFDOzs7O0lBRWpCLFFBQVE7UUFFTixJQUFJLENBQUMsY0FBYyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQ25DLEdBQUc7Ozs7UUFBQyxHQUFHLENBQUMsRUFBRTtZQUNSLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDbkIsQ0FBQyxFQUFDLEVBQ0YsU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FDekIsQ0FBQyxTQUFTLEVBQUUsQ0FBQzs7Y0FDUixjQUFjLEdBQUcs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LCBFdmVudEVtaXR0ZXIsIElucHV0LCBPbkRlc3Ryb3ksIE9uSW5pdCwgT3V0cHV0LCBBZnRlclZpZXdJbml0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBTdWJzY3JpcHRpb24sIGNvbWJpbmVMYXRlc3QsIFN1YmplY3QsIG1lcmdlLCBmcm9tIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgKiBhcyBfIGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBGb3JtQ29udHJvbCAsIEZvcm1Hcm91cH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgRmllbGRDb25maWcgfSBmcm9tICcuLi9jb21tb24tZm9ybS1jb25maWcnO1xuaW1wb3J0IHsgdGFwLCB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmRlY2xhcmUgdmFyIHRyZWVQaWNrZXI6IGFueTtcbmRlY2xhcmUgdmFyICQ6IGFueTtcbmludGVyZmFjZSBUb3BpY1RyZWVOb2RlIHtcbiAgaWQ6IHN0cmluZztcbiAgbmFtZTogc3RyaW5nO1xuICBzZWxlY3RhYmxlOiBzdHJpbmc7XG4gIG5vZGVzOiBBcnJheTxUb3BpY1RyZWVOb2RlPjtcbn1cbmludGVyZmFjZSBKUXVlcnkge1xuICB0cmVlUGlja2VyKG9wdGlvbnM/OiBhbnkpO1xufVxuXG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ3NiLXRvcGljcGlja2VyJyxcbiAgdGVtcGxhdGVVcmw6ICcuL3RvcGljcGlja2VyLmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vdG9waWNwaWNrZXIuY29tcG9uZW50LmNzcyddXG59KVxuZXhwb3J0IGNsYXNzIFRvcGljcGlja2VyQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3ksIEFmdGVyVmlld0luaXQge1xuXG4gIEBJbnB1dCgpIHNlbGVjdGVkVG9waWNzOiBhbnk7XG4gIEBJbnB1dCgpIHRvcGljUGlja2VyQ2xhc3M6IHN0cmluZztcbiAgQElucHV0KCkgbGFiZWw6IFN0cmluZztcbiAgQElucHV0KCkgZGlzYWJsZWQ/OiBib29sZWFuO1xuICBASW5wdXQoKSBwbGFjZWhvbGRlcjogU3RyaW5nO1xuICBASW5wdXQoKSBmb3JtQ29udHJvbFJlZjogRm9ybUNvbnRyb2w7XG4gIEBJbnB1dCgpIGZpZWxkOiBGaWVsZENvbmZpZzxTdHJpbmc+O1xuICBAT3V0cHV0KCkgdG9waWNDaGFuZ2UgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIEBJbnB1dCgpIHZhbGlkYXRpb25zPzogYW55O1xuICBASW5wdXQoKSBmb3JtR3JvdXA/OiBGb3JtR3JvdXA7XG4gIEBJbnB1dCgpIGRlZmF1bHQ/OiBhbnk7XG5cbiAgQElucHV0KCkgZGVwZW5kcz86IEZvcm1Db250cm9sW107XG4gIEBJbnB1dCgpIGRlcGVuZGVuY3lUZXJtcz86IGFueSA9IFtdO1xuICBwdWJsaWMgc2VsZWN0ZWROb2RlczogYW55O1xuICBwdWJsaWMgcGxhY2VIb2xkZXI6IHN0cmluZztcblxuICBwdWJsaWMgaXNEZXBlbmRzSW52YWxpZDogYW55O1xuICBwcml2YXRlIGRpc3Bvc2UkID0gbmV3IFN1YmplY3Q8dW5kZWZpbmVkPigpO1xuICBsYXRlc3RQYXJlbnRWYWx1ZTogc3RyaW5nO1xuICB0ZW1wQXNzb2NpYXRpb246IGFueTtcblxuICBjb25zdHJ1Y3RvcigpIHsgfVxuXG4gIG5nT25Jbml0KCkge1xuXG4gICAgdGhpcy5mb3JtQ29udHJvbFJlZi52YWx1ZUNoYW5nZXMucGlwZShcbiAgICAgIHRhcCh2YWwgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZyh2YWwpO1xuICAgICAgfSksXG4gICAgICB0YWtlVW50aWwodGhpcy5kaXNwb3NlJClcbiAgICApLnN1YnNjcmliZSgpO1xuICAgIGNvbnN0IHNlbGVjdGVkVG9waWNzID0gXy5yZWR1Y2UodGhpcy5kZWZhdWx0LCAoY29sbGVjdG9yLCBlbGVtZW50KSA9PiB7XG4gICAgICBpZiAodHlwZW9mIGVsZW1lbnQgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIGNvbGxlY3Rvci51bmZvcm1hdHRlZC5wdXNoKGVsZW1lbnQpO1xuICAgICAgfSBlbHNlIGlmIChfLmdldChlbGVtZW50LCAnaWRlbnRpZmllcicpKSB7XG4gICAgICAgIGNvbGxlY3Rvci5mb3JtYXR0ZWQucHVzaChlbGVtZW50KTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBjb2xsZWN0b3I7XG4gICAgfSwgeyBmb3JtYXR0ZWQ6IFtdLCB1bmZvcm1hdHRlZDogW10gfSk7XG5cbiAgICB0aGlzLmZvcm1hdFNlbGVjdGVkVG9waWNzKHRoaXMuZmllbGQudGVybXMsIHNlbGVjdGVkVG9waWNzLnVuZm9ybWF0dGVkLCBzZWxlY3RlZFRvcGljcy5mb3JtYXR0ZWQpO1xuICAgIHRoaXMuZGVmYXVsdCA9IHNlbGVjdGVkVG9waWNzLnVuZm9ybWF0dGVkO1xuICAgIHRoaXMuc2VsZWN0ZWROb2RlcyA9IHsgLi4uc2VsZWN0ZWRUb3BpY3MuZm9ybWF0dGVkIH07XG4gICAgdGhpcy50b3BpY0NoYW5nZS5lbWl0KHRoaXMuc2VsZWN0ZWRUb3BpY3MpO1xuXG5cblxuXG4gICAgaWYgKCFfLmlzRW1wdHkodGhpcy5kZWZhdWx0KSkge1xuICAgICAgdGhpcy5wbGFjZUhvbGRlciA9IHRoaXMuZGVmYXVsdCAmJiAgdGhpcy5kZWZhdWx0Lmxlbmd0aCArICcgdG9waWNzIHNlbGVjdGVkJztcbiAgICAgIHRoaXMuZm9ybUNvbnRyb2xSZWYuc2V0VmFsdWUodGhpcy5kZWZhdWx0KTtcbiAgICB9XG5cblxuICAgIGlmICghXy5pc0VtcHR5KHRoaXMuZGVwZW5kcykpIHtcbiAgICAgIG1lcmdlKC4uLl8ubWFwKHRoaXMuZGVwZW5kcywgZGVwZW5kID0+IGRlcGVuZC52YWx1ZUNoYW5nZXMpKS5waXBlKFxuICAgICAgIHRhcCgodmFsdWU6IGFueSkgPT4ge1xuICAgICAgICAgdGhpcy5sYXRlc3RQYXJlbnRWYWx1ZSA9IHZhbHVlO1xuICAgICAgICAgdGhpcy5pc0RlcGVuZHNJbnZhbGlkID0gXy5pbmNsdWRlcyhfLm1hcCh0aGlzLmRlcGVuZHMsIGRlcGVuZCA9PiBkZXBlbmQuaW52YWxpZCksIHRydWUpO1xuICAgICAgICAgdGhpcy5mb3JtQ29udHJvbFJlZi5wYXRjaFZhbHVlKG51bGwpO1xuICAgICAgICAgdGhpcy5wbGFjZUhvbGRlciA9ICcnO1xuICAgICAgICAgdGhpcy5kZWZhdWx0ID0gW107XG4gICAgICAgICB0aGlzLnNlbGVjdGVkTm9kZXMgPSB7fTtcbiAgICAgICAgIHRoaXMuaW5pdFRvcGljUGlja2VyKHRoaXMuZm9ybWF0VG9waWNzKHRoaXMuZmV0Y2hBc3NvY2lhdGlvbnMoKSkpO1xuICAgICAgIH0pLFxuICAgICAgIHRha2VVbnRpbCh0aGlzLmRpc3Bvc2UkKVxuICAgICAgICkuc3Vic2NyaWJlKCk7XG5cbiAgICAgICB0aGlzLmlzRGVwZW5kc0ludmFsaWQgPSBfLmluY2x1ZGVzKF8ubWFwKHRoaXMuZGVwZW5kcywgZGVwZW5kID0+IGRlcGVuZC5pbnZhbGlkKSwgdHJ1ZSk7XG4gICAgIH1cblxuICB9XG5cbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnVzZS1saWZlLWN5Y2xlLWludGVyZmFjZVxuICBuZ0FmdGVyVmlld0luaXQoKSB7XG4gICAgdGhpcy5pbml0VG9waWNQaWNrZXIodGhpcy5mb3JtYXRUb3BpY3ModGhpcy5maWVsZC50ZXJtcykpO1xuXG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLmRpc3Bvc2UkLm5leHQobnVsbCk7XG4gICAgdGhpcy5kaXNwb3NlJC5jb21wbGV0ZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBmb3JtYXRUb3BpY3ModG9waWNzLCBzdWJUb3BpYyA9IGZhbHNlKTogQXJyYXk8VG9waWNUcmVlTm9kZT4ge1xuICAgIHJldHVybiBfLm1hcCh0b3BpY3MsICh0b3BpYykgPT4gKHtcbiAgICAgIGlkOiB0b3BpYy5pZGVudGlmaWVyLFxuICAgICAgbmFtZTogdG9waWMubmFtZSxcbiAgICAgIHNlbGVjdGFibGU6IHN1YlRvcGljID8gJ3NlbGVjdGFibGUnIDogJ25vdHNlbGVjdGFibGUnLFxuICAgICAgbm9kZXM6IHRoaXMuZm9ybWF0VG9waWNzKHRvcGljLmNoaWxkcmVuLCB0cnVlKVxuICAgIH0pKTtcbiAgfVxuXG4gIHByaXZhdGUgZm9ybWF0U2VsZWN0ZWRUb3BpY3ModG9waWNzLCB1bmZvcm1hdHRlZCwgZm9ybWF0dGVkKSB7XG4gICAgXy5mb3JFYWNoKHRvcGljcywgKHRvcGljKSA9PiB7XG4gICAgICBpZiAodW5mb3JtYXR0ZWQuaW5jbHVkZXModGhpcy5maWVsZC5vdXRwdXQgPyB0b3BpY1t0aGlzLmZpZWxkLm91dHB1dF0gOiB0b3BpYy5uYW1lKSAmJiAhdG9waWMuY2hpbGRyZW4pIHtcbiAgICAgICAgZm9ybWF0dGVkLnB1c2goe1xuICAgICAgICAgIGlkZW50aWZpZXI6IHRvcGljLmlkZW50aWZpZXIsXG4gICAgICAgICAgbmFtZTogdG9waWMubmFtZVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIGlmICh0b3BpYy5jaGlsZHJlbikge1xuICAgICAgICB0aGlzLmZvcm1hdFNlbGVjdGVkVG9waWNzKHRvcGljLmNoaWxkcmVuLCB1bmZvcm1hdHRlZCwgZm9ybWF0dGVkKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgaW5pdFRvcGljUGlja2VyKGRhdGE6IEFycmF5PFRvcGljVHJlZU5vZGU+KSB7XG4gICAgICAkKGAudG9waWMtcGlja2VyLXNlbGVjdG9yXyR7dGhpcy5maWVsZC5jb2RlfWApLnRyZWVQaWNrZXIoe1xuICAgICAgICBkYXRhOiBkYXRhLFxuICAgICAgICBuYW1lOiAnVG9waWNzJyxcbiAgICAgICAgbm9EYXRhTWVzc2FnZTogJ25vRGF0YU1lc3NhZ2UnLFxuICAgICAgICBzdWJtaXRCdXR0b25UZXh0OiAnRG9uZScsXG4gICAgICAgIGNhbmNlbEJ1dHRvblRleHQ6ICdDYW5jZWwnLFxuICAgICAgICByZW1vdmVBbGxUZXh0OiAnUmVtb3ZlIEFsbCcsXG4gICAgICAgIGNob29zZUFsbFRleHQ6ICdDaG9vc2UgQWxsJyxcbiAgICAgICAgc2VhcmNoVGV4dDogJ1NlYXJjaCcsXG4gICAgICAgIHNlbGVjdGVkVGV4dDogJ3NlbGVjdGVkJyxcbiAgICAgICAgcGlja2VkOiAoIV8uaXNFbXB0eSh0aGlzLnNlbGVjdGVkTm9kZXMpKSA/IF8ubWFwKHRoaXMuc2VsZWN0ZWROb2RlcywgJ2lkZW50aWZpZXInKSA6ICghXy5pc0VtcHR5KHRoaXMuZGVmYXVsdCkgPyB0aGlzLmRlZmF1bHQgOiBbXSksXG4gICAgICAgIG9uU3VibWl0OiAoc2VsZWN0ZWROb2RlcykgPT4ge1xuICAgICAgICAgIHRoaXMuc2VsZWN0ZWROb2RlcyA9IHNlbGVjdGVkTm9kZXM7XG4gICAgICAgICAgdGhpcy5zZWxlY3RlZFRvcGljcyA9IF8ubWFwKHNlbGVjdGVkTm9kZXMsIG5vZGUgPT4gKHtcbiAgICAgICAgICAgIGlkZW50aWZpZXI6IG5vZGUuaWQsXG4gICAgICAgICAgICBuYW1lOiBub2RlLm5hbWVcbiAgICAgICAgICB9KSk7XG4gICAgICAgICAgdGhpcy5wbGFjZUhvbGRlciA9IHRoaXMuc2VsZWN0ZWRUb3BpY3MubGVuZ3RoICsgJyB0b3BpY3Mgc2VsZWN0ZWQnO1xuICAgICAgICAgIHRoaXMudG9waWNDaGFuZ2UuZW1pdCh0aGlzLnNlbGVjdGVkVG9waWNzKTtcbiAgICAgICAgICBjb25zdCB0b3BpY3MgPSBbXTtcbiAgICAgICAgICBfLmZvckVhY2godGhpcy5zZWxlY3RlZFRvcGljcywgKHZhbHVlLCBpbmRleCkgPT4ge1xuICAgICAgICAgICAgaWYgKHRoaXMuZmllbGQub3V0cHV0KSB7XG4gICAgICAgICAgICAgdG9waWNzLnB1c2godmFsdWVbdGhpcy5maWVsZC5vdXRwdXRdKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHRvcGljcy5wdXNoKHZhbHVlLm5hbWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICAgIHRoaXMuZm9ybUNvbnRyb2xSZWYuc2V0VmFsdWUodG9waWNzKTtcbiAgICAgICAgfSxcbiAgICAgICAgbm9kZU5hbWU6IGB0b3BpY1NlbGVjdG9yXyR7dGhpcy5maWVsZC5jb2RlfWAsXG4gICAgICAgIGRpc3BsYXlGb3JtYXQ6IGZ1bmN0aW9uKHBpY2tlZCkgeyByZXR1cm4gdGhpcy5wbGFjZUhvbGRlcjsgfSAsXG4gICAgICAgIG1pblNlYXJjaFF1ZXJ5TGVuZ3RoOiAxLFxuICAgICAgICBkaXNhYmxlZDogKG5vZGUpICA9PiB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuZGlzYWJsZWQgPyB0cnVlIDogKCB0aGlzLmRlcGVuZHMgPyAodGhpcy5pc0RlcGVuZHNJbnZhbGlkID8gdHJ1ZSA6IGZhbHNlKSA6IGZhbHNlIClcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICBzZXRUaW1lb3V0KCgpID0+IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGB0b3BpY1NlbGVjdG9yXyR7dGhpcy5maWVsZC5jb2RlfWApLmNsYXNzTGlzdC5hZGQodGhpcy50b3BpY1BpY2tlckNsYXNzKSwgMCk7XG4gIH1cblxuICBmZXRjaEFzc29jaWF0aW9ucygpIHtcbiAgICAvLyAmJiB0aGlzLmNvbnRleHQudmFsdWUgJiYgdGhpcy5maWVsZC5hc3NvY2lhdGlvblxuICAgIGlmICghXy5pc0VtcHR5KHRoaXMuZGVwZW5kcykpIHtcbiAgICAgIGNvbnN0IGZpbHRlcmVkVGVybSA9IF8uZmluZCh0aGlzLmRlcGVuZGVuY3lUZXJtcywgdGVybXMgPT4ge1xuICAgICAgICByZXR1cm4gIV8uaXNFbXB0eSh0aGlzLmZpZWxkLm91dHB1dCkgPyBfLmluY2x1ZGVzKHRoaXMuZ2V0UGFyZW50VmFsdWUoKSwgdGVybXNbdGhpcy5maWVsZC5vdXRwdXRdKSA6XG4gICAgICAgICBfLmluY2x1ZGVzKHRoaXMuZ2V0UGFyZW50VmFsdWUoKSwgdGVybXMubmFtZSkgO1xuICAgICAgfSk7XG4gICAgICBpZiAoZmlsdGVyZWRUZXJtKSB7XG4gICAgICAgIHRoaXMudGVtcEFzc29jaWF0aW9uID0gIF8uZmlsdGVyKGZpbHRlcmVkVGVybS5hc3NvY2lhdGlvbnMsIGFzc29jaWF0aW9uID0+IHtcbiAgICAgICAgICByZXR1cm4gKHRoaXMuZmllbGQuc291cmNlQ2F0ZWdvcnkpID8gKGFzc29jaWF0aW9uLmNhdGVnb3J5ID09PSB0aGlzLmZpZWxkLnNvdXJjZUNhdGVnb3J5KSA6XG4gICAgICAgICAgIGFzc29jaWF0aW9uLmNhdGVnb3J5ID09PSB0aGlzLmZpZWxkLmNvZGU7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gdGhpcy50ZW1wQXNzb2NpYXRpb247XG4gICAgICB9IGVsc2UgIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZmllbGQudGVybXM7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLmZpZWxkLnRlcm1zO1xuICAgIH1cbiAgfVxuXG4gIGdldFBhcmVudFZhbHVlKCkge1xuICAgIHJldHVybiB0aGlzLmxhdGVzdFBhcmVudFZhbHVlIHx8IF8uY29tcGFjdChfLm1hcCh0aGlzLmRlcGVuZHMsICd2YWx1ZScpKTtcbiAgfVxuXG59XG4iXX0=