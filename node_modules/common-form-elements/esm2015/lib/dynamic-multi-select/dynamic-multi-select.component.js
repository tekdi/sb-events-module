/**
 * @fileoverview added by tsickle
 * Generated from: lib/dynamic-multi-select/dynamic-multi-select.component.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, Input, Output, EventEmitter } from '@angular/core';
import { FormControl, FormGroup } from '@angular/forms';
import { Subject, merge } from 'rxjs';
import { tap } from 'rxjs/operators';
import * as _ from 'lodash-es';
import { ValueComparator } from '../utilities/value-comparator';
export class DynamicMultiSelectComponent {
    constructor() {
        this.ValueComparator = ValueComparator;
        this.onChangeFilter = new EventEmitter();
        this.dependencyTerms = [];
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    ngOnChanges(changes) {
        if (!this.options) {
            this.options = [];
        }
        if (this.isOptionsClosure(this.options)) {
            this.options$ = (/** @type {?} */ (((/** @type {?} */ (this.options)))(this.formControlRef, this.depends, this.formGroup, (/**
             * @return {?}
             */
            () => this.dataLoadStatusDelegate.next('LOADING')), (/**
             * @return {?}
             */
            () => this.dataLoadStatusDelegate.next('LOADED')))));
        }
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        // if (this.context) {
        // this.contextValueChangesSubscription = this.context.valueChanges.pipe(
        //   tap(() => {
        //     this.formControlRef.patchValue(null);
        //   })
        // ).subscribe();
        // }
        this.dataLoadStatusDelegate.subscribe(console.log);
        if (this.field && this.field.range) {
            this.options = this.field.range;
        }
        if (!_.isEmpty(this.depends) && !this.isOptionsClosure(this.options)) {
            this.contextValueChangesSubscription = merge(..._.map(this.depends, (/**
             * @param {?} depend
             * @return {?}
             */
            depend => depend.valueChanges))).pipe(tap((/**
             * @param {?} value
             * @return {?}
             */
            (value) => {
                this.latestParentValue = value;
            }))).subscribe();
        }
        if (!_.isEmpty(this.field.depends)) {
            merge(..._.map(this.depends, (/**
             * @param {?} depend
             * @return {?}
             */
            depend => depend.valueChanges))).pipe(tap((/**
             * @return {?}
             */
            () => {
                // _.forEach(this.field.depends, depend => {
                //   if (!_.isEmpty(this.formGroup.get(depend))) {
                //     this.formGroup.get(depend).patchValue(null);
                //   }
                // });
                this.formControlRef.patchValue(null);
            }))).subscribe();
        }
        if (this.isOptionsClosure(this.options)) {
            // tslint:disable-next-line:max-line-length
            this.options$ = (/** @type {?} */ (((/** @type {?} */ (this.options)))(this.formControlRef, this.depends, this.formGroup, (/**
             * @return {?}
             */
            () => this.dataLoadStatusDelegate.next('LOADING')), (/**
             * @return {?}
             */
            () => this.dataLoadStatusDelegate.next('LOADED')))));
        }
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        if (this.contextValueChangesSubscription) {
            this.contextValueChangesSubscription.unsubscribe();
        }
    }
    /**
     * @param {?} options
     * @return {?}
     */
    isOptionsArray(options) {
        return Array.isArray(options);
    }
    /**
     * @param {?} options
     * @return {?}
     */
    isOptionsClosure(options) {
        return typeof options === 'function';
    }
    /**
     * @param {?} input
     * @return {?}
     */
    isOptionsMap(input) {
        return !Array.isArray(input) && typeof input === 'object';
    }
    /**
     * @param {?} input
     * @return {?}
     */
    isOptionsArrayMap(input) {
        return Array.isArray(input) && typeof input[0] === 'object';
    }
    /**
     * @param {?} $event
     * @return {?}
     */
    onChangeFacet($event) {
        /** @type {?} */
        const selectedObject = this.options.data[$event.currentTarget.options.selectedIndex - 1];
        /** @type {?} */
        const emitPayload = JSON.parse(JSON.stringify(this.options));
        emitPayload['data'] = selectedObject;
        emitPayload['selectedLabel'] = selectedObject.label;
        emitPayload['selectedValue'] = selectedObject.value;
        this.onChangeFilter.emit(emitPayload);
    }
    /**
     * @return {?}
     */
    fetchAssociations() {
        // && this.context.value && this.field.association
        if (!_.isEmpty(this.depends)) {
            /** @type {?} */
            const filteredTerm = _.find(this.dependencyTerms, (/**
             * @param {?} terms
             * @return {?}
             */
            terms => {
                return _.includes(this.getParentValue(), terms.identifier);
            }));
            if (filteredTerm) {
                this.tempAssociation = _.filter(filteredTerm.associations, (/**
                 * @param {?} association
                 * @return {?}
                 */
                association => {
                    return association.category === this.field.code;
                }));
                return this.tempAssociation;
            }
            else {
                return this.options;
            }
        }
        else {
            return this.options;
        }
    }
    /**
     * @return {?}
     */
    getParentValue() {
        return this.latestParentValue || _.compact(_.map(this.depends, 'value'));
    }
}
DynamicMultiSelectComponent.decorators = [
    { type: Component, args: [{
                selector: 'sb-dynamic-multi-select',
                template: "<div class=\"sb-dropdown\" *ngIf=\"!type\">\n  <label>{{label}} {{context && 'has context'}}  {{context ?  field.context : '' }}</label>\n  <ng-container *ngIf=\"options\">\n    <div class=\"dropdown-container\">\n      <sb-icon-dropdown class=\"dropdown-icon\"></sb-icon-dropdown>\n      <!-- [attr.disabled]=\"disabled ? true : ( context ? (context.invalid ? true : null) : null )\" -->\n      <select [formControl]=\"formControlRef\"\n              [compareWith]=\"ValueComparator.valueComparator\" class=\"sb-dropdown-select\" id=\"sb-dropdown\"\n              name=\"sb-dropdown\" multiple>\n        <option [defaultSelected]=\"!default\" [ngValue]=\"null\" disabled>{{placeHolder}}\n        </option>\n        <ng-container *ngIf=\"field.range && isOptionsArrayMap(field.range) && !field.association\">\n          <option class=\"optionsArrayMap\" *ngFor=\"let option of field.range\" [ngValue]=\"option.value\">{{option.label}}</option>\n        </ng-container>\n        <ng-container *ngIf=\"field.range && isOptionsArray(field.range) && !isOptionsArrayMap(field.range) && !field.association\">\n          <option class=\"optionsArray\" *ngFor=\"let option of field.range\" [ngValue]=\"option || option\">{{option.name || option}}</option>\n        </ng-container>\n\n        <ng-container *ngIf=\"field.range && isOptionsClosure(field.range)\">\n          <option class=\"closure\" *ngFor=\"let option of options$ | async\" [ngValue]=\"option.value\">{{option.label}}</option>\n        </ng-container>\n\n        <!-- <ng-container *ngIf=\"isOptionsMap(options) && context && context.value && !field.association\">\n          <option *ngFor=\"let option of options[context.value]\" [ngValue]=\"option.value\">{{option.label}}</option>\n        </ng-container> -->\n\n        <ng-container *ngIf=\"!field.range && field.terms\">\n          <option class=\"optionsLast\" *ngFor=\"let option of fetchAssociations()\" [ngValue]=\"option.identifier\">{{option.name}}</option>\n        </ng-container>\n      </select>\n    </div>\n  </ng-container>\n</div>\n\n<!-- Dropdown for filters component -->\n<div class=\"sb-dropdown\" *ngIf=\"type === 'facet'\">\n  <label>{{label}}</label>\n  <ng-container *ngIf=\"options && options.data\">\n    <div class=\"dropdown-container\">\n      <sb-icon-dropdown class=\"dropdown-icon\"></sb-icon-dropdown>\n      <select [attr.disabled]=\"disabled ? true : ( context ? (context.invalid ? true : null) : null )\"\n        class=\"sb-dropdown-select\" [ngClass]=\"(styleClass ? styleClass : 'default-dropdown')\" id=\"sb-dropdown\" name=\"sb-dropdown\"\n        (change)=\"onChangeFacet($event)\" placeholder=\"placeHolder\">\n        <option *ngIf=\"!default\" [disabled]=\"true\" selected>{{placeHolder}}</option>\n        <option *ngFor=\"let option of options.data\" [ngValue]=\"option\" [selected]=\"options.default === option.value\">{{option.label}}</option>\n      </select>\n    </div>\n  </ng-container>\n</div>\n<ng-container *ngFor=\"let validation of validations\">\n  <div class=\"cf-error\"\n    *ngIf=\"(validation.type && (validation.type).toLowerCase() && validation.message && formControlRef.errors && formControlRef.errors[(validation.type).toLowerCase()] && (formControlRef.dirty || formControlRef.touched))\">\n    {{ validation.message }}\n  </div>\n</ng-container>\n\n<!-- Dropdown for filters component -->\n",
                styles: ["label{display:block;padding:10px;font-size:1rem}.dropdown-icon{position:absolute;top:.5rem;right:18px;z-index:1}.dropdown-container{position:relative}select[disabled]{opacity:.3}select{-webkit-appearance:none;-moz-appearance:none;text-indent:1px;text-overflow:''}.sb-dropdown-select{opacity:.99;color:#333;font-family:\"Noto Sans\";font-size:12px;font-weight:700;letter-spacing:0;line-height:17px}.sb-dropdown{margin-bottom:8px}.placeholder select option:first-child{color:#999}.option-default{color:#333;font-weight:700;font-size:12px}.sb-dropdown select{background-color:#fff;padding:10px 20px;font-size:14px;width:100%;border:.5px solid #333}.cf-error{color:red;font-family:\"Noto Sans\";font-size:12px}"]
            }] }
];
/** @nocollapse */
DynamicMultiSelectComponent.ctorParameters = () => [];
DynamicMultiSelectComponent.propDecorators = {
    field: [{ type: Input }],
    disabled: [{ type: Input }],
    options: [{ type: Input }],
    label: [{ type: Input }],
    placeHolder: [{ type: Input }],
    isMultiple: [{ type: Input }],
    context: [{ type: Input }],
    contextTerms: [{ type: Input }],
    formControlRef: [{ type: Input }],
    formGroup: [{ type: Input }],
    default: [{ type: Input }],
    contextData: [{ type: Input }],
    dataLoadStatusDelegate: [{ type: Input }],
    type: [{ type: Input }],
    styleClass: [{ type: Input }],
    onChangeFilter: [{ type: Output }],
    validations: [{ type: Input }],
    depends: [{ type: Input }],
    dependencyTerms: [{ type: Input }]
};
if (false) {
    /** @type {?} */
    DynamicMultiSelectComponent.prototype.ValueComparator;
    /** @type {?} */
    DynamicMultiSelectComponent.prototype.field;
    /** @type {?} */
    DynamicMultiSelectComponent.prototype.disabled;
    /** @type {?} */
    DynamicMultiSelectComponent.prototype.options;
    /** @type {?} */
    DynamicMultiSelectComponent.prototype.label;
    /** @type {?} */
    DynamicMultiSelectComponent.prototype.placeHolder;
    /** @type {?} */
    DynamicMultiSelectComponent.prototype.isMultiple;
    /** @type {?} */
    DynamicMultiSelectComponent.prototype.context;
    /** @type {?} */
    DynamicMultiSelectComponent.prototype.contextTerms;
    /** @type {?} */
    DynamicMultiSelectComponent.prototype.formControlRef;
    /** @type {?} */
    DynamicMultiSelectComponent.prototype.formGroup;
    /** @type {?} */
    DynamicMultiSelectComponent.prototype.default;
    /** @type {?} */
    DynamicMultiSelectComponent.prototype.contextData;
    /** @type {?} */
    DynamicMultiSelectComponent.prototype.dataLoadStatusDelegate;
    /** @type {?} */
    DynamicMultiSelectComponent.prototype.type;
    /** @type {?} */
    DynamicMultiSelectComponent.prototype.styleClass;
    /** @type {?} */
    DynamicMultiSelectComponent.prototype.onChangeFilter;
    /** @type {?} */
    DynamicMultiSelectComponent.prototype.validations;
    /** @type {?} */
    DynamicMultiSelectComponent.prototype.depends;
    /** @type {?} */
    DynamicMultiSelectComponent.prototype.dependencyTerms;
    /** @type {?} */
    DynamicMultiSelectComponent.prototype.options$;
    /** @type {?} */
    DynamicMultiSelectComponent.prototype.contextValueChangesSubscription;
    /** @type {?} */
    DynamicMultiSelectComponent.prototype.selectedType;
    /** @type {?} */
    DynamicMultiSelectComponent.prototype.tempAssociation;
    /** @type {?} */
    DynamicMultiSelectComponent.prototype.latestParentValue;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pYy1tdWx0aS1zZWxlY3QuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vY29tbW9uLWZvcm0tZWxlbWVudHMvIiwic291cmNlcyI6WyJsaWIvZHluYW1pYy1tdWx0aS1zZWxlY3QvZHluYW1pYy1tdWx0aS1zZWxlY3QuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFDLFNBQVMsRUFBRSxLQUFLLEVBQWdDLE1BQU0sRUFBaUIsWUFBWSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ2xILE9BQU8sRUFBQyxXQUFXLEVBQUUsU0FBUyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDdEQsT0FBTyxFQUFhLE9BQU8sRUFBK0IsS0FBSyxFQUFDLE1BQU0sTUFBTSxDQUFDO0FBRTdFLE9BQU8sRUFBQyxHQUFHLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUNuQyxPQUFPLEtBQUssQ0FBQyxNQUFNLFdBQVcsQ0FBQztBQUMvQixPQUFPLEVBQUMsZUFBZSxFQUFDLE1BQU0sK0JBQStCLENBQUM7QUFNOUQsTUFBTSxPQUFPLDJCQUEyQjtJQTRCdEM7UUEzQkEsb0JBQWUsR0FBRyxlQUFlLENBQUM7UUFnQnhCLG1CQUFjLEdBQXNCLElBQUksWUFBWSxFQUFFLENBQUM7UUFJeEQsb0JBQWUsR0FBUyxFQUFFLENBQUM7SUFRcEMsQ0FBQzs7Ozs7SUFFRCxXQUFXLENBQUMsT0FBc0I7UUFDaEMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDakIsSUFBSSxDQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7U0FDbkI7UUFDRCxJQUFJLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUU7WUFDdkMsSUFBSSxDQUFDLFFBQVEsR0FBRyxtQkFBQSxDQUFDLG1CQUFBLElBQUksQ0FBQyxPQUFPLEVBQXlDLENBQUMsQ0FDckUsSUFBSSxDQUFDLGNBQWMsRUFDbkIsSUFBSSxDQUFDLE9B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REFBNEI7O0lBQzVCLHFEQUFzQzs7SUFDdEMsZ0RBQStCOztJQUMvQiw4Q0FBdUI7O0lBQ3ZCLGtEQUEwQjs7SUFDMUIsNkRBQStEOztJQUMvRCwyQ0FBdUI7O0lBQ3ZCLGlEQUE2Qjs7SUFDN0IscURBQWlFOztJQUNqRSxrREFBMkI7O0lBRTNCLDhDQUFpQzs7SUFDakMsc0RBQW9DOztJQUVwQywrQ0FBZ0Q7O0lBQ2hELHNFQUErQzs7SUFDL0MsbURBQWtCOztJQUNsQixzREFBcUI7O0lBQ3JCLHdEQUEwQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q29tcG9uZW50LCBJbnB1dCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3ksIE9uSW5pdCwgT3V0cHV0LCBTaW1wbGVDaGFuZ2VzLCBFdmVudEVtaXR0ZXJ9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtGb3JtQ29udHJvbCwgRm9ybUdyb3VwfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5pbXBvcnQge09ic2VydmFibGUsIFN1YmplY3QsIFN1YnNjcmlwdGlvbiwgY29tYmluZUxhdGVzdCwgbWVyZ2V9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtGaWVsZENvbmZpZywgRmllbGRDb25maWdPcHRpb24sIEZpZWxkQ29uZmlnT3B0aW9uc0J1aWxkZXIsIER5bmFtaWNGaWVsZENvbmZpZ09wdGlvbnNCdWlsZGVyfSBmcm9tICcuLi9jb21tb24tZm9ybS1jb25maWcnO1xuaW1wb3J0IHt0YXB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7VmFsdWVDb21wYXJhdG9yfSBmcm9tICcuLi91dGlsaXRpZXMvdmFsdWUtY29tcGFyYXRvcic7XG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdzYi1keW5hbWljLW11bHRpLXNlbGVjdCcsXG4gIHRlbXBsYXRlVXJsOiAnLi9keW5hbWljLW11bHRpLXNlbGVjdC5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL2R5bmFtaWMtbXVsdGktc2VsZWN0LmNvbXBvbmVudC5jc3MnXVxufSlcbmV4cG9ydCBjbGFzcyBEeW5hbWljTXVsdGlTZWxlY3RDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcywgT25EZXN0cm95IHtcbiAgVmFsdWVDb21wYXJhdG9yID0gVmFsdWVDb21wYXJhdG9yO1xuICBASW5wdXQoKSBmaWVsZDogRmllbGRDb25maWc8U3RyaW5nPjtcbiAgQElucHV0KCkgZGlzYWJsZWQ/OiBib29sZWFuO1xuICBASW5wdXQoKSBvcHRpb25zOiBhbnk7XG4gIEBJbnB1dCgpIGxhYmVsPzogc3RyaW5nO1xuICBASW5wdXQoKSBwbGFjZUhvbGRlcj86IHN0cmluZztcbiAgQElucHV0KCkgaXNNdWx0aXBsZT86IGJvb2xlYW47XG4gIEBJbnB1dCgpIGNvbnRleHQ/OiBGb3JtQ29udHJvbDtcbiAgQElucHV0KCkgY29udGV4dFRlcm1zPzogYW55O1xuICBASW5wdXQoKSBmb3JtQ29udHJvbFJlZj86IEZvcm1Db250cm9sO1xuICBASW5wdXQoKSBmb3JtR3JvdXA/OiBGb3JtR3JvdXA7XG4gIEBJbnB1dCgpIGRlZmF1bHQ/OiBhbnk7XG4gIEBJbnB1dCgpIGNvbnRleHREYXRhOiBhbnk7XG4gIEBJbnB1dCgpIGRhdGFMb2FkU3RhdHVzRGVsZWdhdGU6IFN1YmplY3Q8J0xPQURJTkcnIHwgJ0xPQURFRCc+O1xuICBASW5wdXQoKSB0eXBlPzogc3RyaW5nO1xuICBASW5wdXQoKSBzdHlsZUNsYXNzPzogc3RyaW5nO1xuICBAT3V0cHV0KCkgb25DaGFuZ2VGaWx0ZXI6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICBASW5wdXQoKSB2YWxpZGF0aW9ucz86IGFueTtcblxuICBASW5wdXQoKSBkZXBlbmRzPzogRm9ybUNvbnRyb2xbXTtcbiAgQElucHV0KCkgZGVwZW5kZW5jeVRlcm1zPzogYW55ID0gW107XG5cbiAgb3B0aW9ucyQ/OiBPYnNlcnZhYmxlPEZpZWxkQ29uZmlnT3B0aW9uPGFueT5bXT47XG4gIGNvbnRleHRWYWx1ZUNoYW5nZXNTdWJzY3JpcHRpb24/OiBTdWJzY3JpcHRpb247XG4gIHNlbGVjdGVkVHlwZTogYW55O1xuICB0ZW1wQXNzb2NpYXRpb246IGFueTtcbiAgbGF0ZXN0UGFyZW50VmFsdWU6IHN0cmluZztcbiAgY29uc3RydWN0b3IoKSB7XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLm9wdGlvbnMpIHtcbiAgICAgIHRoaXMub3B0aW9ucyA9IFtdO1xuICAgIH1cbiAgICBpZiAodGhpcy5pc09wdGlvbnNDbG9zdXJlKHRoaXMub3B0aW9ucykpIHtcbiAgICAgIHRoaXMub3B0aW9ucyQgPSAodGhpcy5vcHRpb25zIGFzIER5bmFtaWNGaWVsZENvbmZpZ09wdGlvbnNCdWlsZGVyPGFueT4pKFxuICAgICAgICB0aGlzLmZvcm1Db250cm9sUmVmLFxuICAgICAgICB0aGlzLmRlcGVuZHMsXG4gICAgICAgIHRoaXMuZm9ybUdyb3VwLFxuICAgICAgICAoKSA9PiB0aGlzLmRhdGFMb2FkU3RhdHVzRGVsZWdhdGUubmV4dCgnTE9BRElORycpLFxuICAgICAgICAoKSA9PiB0aGlzLmRhdGFMb2FkU3RhdHVzRGVsZWdhdGUubmV4dCgnTE9BREVEJylcbiAgICAgICkgYXMgYW55O1xuICAgIH1cbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIC8vIGlmICh0aGlzLmNvbnRleHQpIHtcbiAgICAgIC8vIHRoaXMuY29udGV4dFZhbHVlQ2hhbmdlc1N1YnNjcmlwdGlvbiA9IHRoaXMuY29udGV4dC52YWx1ZUNoYW5nZXMucGlwZShcbiAgICAgIC8vICAgdGFwKCgpID0+IHtcbiAgICAgIC8vICAgICB0aGlzLmZvcm1Db250cm9sUmVmLnBhdGNoVmFsdWUobnVsbCk7XG4gICAgICAvLyAgIH0pXG4gICAgICAvLyApLnN1YnNjcmliZSgpO1xuICAgIC8vIH1cblxuICAgIHRoaXMuZGF0YUxvYWRTdGF0dXNEZWxlZ2F0ZS5zdWJzY3JpYmUoXG4gICAgICBjb25zb2xlLmxvZ1xuICAgICk7XG5cbiAgICBpZiAodGhpcy5maWVsZCAmJiB0aGlzLmZpZWxkLnJhbmdlKSB7XG4gICAgICB0aGlzLm9wdGlvbnMgPSB0aGlzLmZpZWxkLnJhbmdlO1xuICAgIH1cblxuXG4gICAgaWYgKCFfLmlzRW1wdHkodGhpcy5kZXBlbmRzKSAmJiAhdGhpcy5pc09wdGlvbnNDbG9zdXJlKHRoaXMub3B0aW9ucykpIHtcbiAgICAgdGhpcy5jb250ZXh0VmFsdWVDaGFuZ2VzU3Vic2NyaXB0aW9uID0gIG1lcmdlKC4uLl8ubWFwKHRoaXMuZGVwZW5kcywgZGVwZW5kID0+IGRlcGVuZC52YWx1ZUNoYW5nZXMpKS5waXBlKFxuICAgICAgdGFwKCh2YWx1ZTogYW55KSA9PiB7XG4gICAgICAgIHRoaXMubGF0ZXN0UGFyZW50VmFsdWUgPSB2YWx1ZTtcbiAgICAgIH0pXG4gICAgICApLnN1YnNjcmliZSgpO1xuICAgIH1cblxuICAgIGlmICghXy5pc0VtcHR5KHRoaXMuZmllbGQuZGVwZW5kcykpIHtcbiAgICAgIG1lcmdlKC4uLl8ubWFwKHRoaXMuZGVwZW5kcywgZGVwZW5kID0+IGRlcGVuZC52YWx1ZUNoYW5nZXMpKS5waXBlKFxuICAgICAgICAgIHRhcCgoKSA9PiB7XG4gICAgICAgICAgICAvLyBfLmZvckVhY2godGhpcy5maWVsZC5kZXBlbmRzLCBkZXBlbmQgPT4ge1xuICAgICAgICAgICAgLy8gICBpZiAoIV8uaXNFbXB0eSh0aGlzLmZvcm1Hcm91cC5nZXQoZGVwZW5kKSkpIHtcbiAgICAgICAgICAgIC8vICAgICB0aGlzLmZvcm1Hcm91cC5nZXQoZGVwZW5kKS5wYXRjaFZhbHVlKG51bGwpO1xuICAgICAgICAgICAgLy8gICB9XG4gICAgICAgICAgICAvLyB9KTtcbiAgICAgICAgICAgIHRoaXMuZm9ybUNvbnRyb2xSZWYucGF0Y2hWYWx1ZShudWxsKTtcbiAgICAgICAgICB9KVxuICAgICAgKS5zdWJzY3JpYmUoKTtcbiAgICB9XG5cblxuICAgIGlmICh0aGlzLmlzT3B0aW9uc0Nsb3N1cmUodGhpcy5vcHRpb25zKSkge1xuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aFxuICAgICAgdGhpcy5vcHRpb25zJCA9ICh0aGlzLm9wdGlvbnMgYXMgRHluYW1pY0ZpZWxkQ29uZmlnT3B0aW9uc0J1aWxkZXI8YW55PikodGhpcy5mb3JtQ29udHJvbFJlZiwgdGhpcy5kZXBlbmRzLCB0aGlzLmZvcm1Hcm91cCwgKCkgPT4gdGhpcy5kYXRhTG9hZFN0YXR1c0RlbGVnYXRlLm5leHQoJ0xPQURJTkcnKSwgKCkgPT4gdGhpcy5kYXRhTG9hZFN0YXR1c0RlbGVnYXRlLm5leHQoJ0xPQURFRCcpKSBhcyBhbnk7XG4gICAgfVxuXG5cblxuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuY29udGV4dFZhbHVlQ2hhbmdlc1N1YnNjcmlwdGlvbikge1xuICAgICAgdGhpcy5jb250ZXh0VmFsdWVDaGFuZ2VzU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuICB9XG5cbiAgaXNPcHRpb25zQXJyYXkob3B0aW9uczogYW55KSB7XG4gICAgcmV0dXJuIEFycmF5LmlzQXJyYXkob3B0aW9ucyk7XG5cbiAgfVxuXG4gIGlzT3B0aW9uc0Nsb3N1cmUob3B0aW9uczogYW55KSB7XG4gICAgcmV0dXJuIHR5cGVvZiBvcHRpb25zID09PSAnZnVuY3Rpb24nO1xuICB9XG5cbiAgaXNPcHRpb25zTWFwKGlucHV0OiBhbnkpIHtcbiAgICByZXR1cm4gIUFycmF5LmlzQXJyYXkoaW5wdXQpICYmIHR5cGVvZiBpbnB1dCA9PT0gJ29iamVjdCc7XG4gIH1cblxuICBpc09wdGlvbnNBcnJheU1hcChpbnB1dDogYW55KSB7XG4gICAgcmV0dXJuIEFycmF5LmlzQXJyYXkoaW5wdXQpICYmIHR5cGVvZiBpbnB1dFswXSA9PT0gJ29iamVjdCc7XG4gIH1cblxuICBvbkNoYW5nZUZhY2V0KCRldmVudCkge1xuICAgIGNvbnN0IHNlbGVjdGVkT2JqZWN0ID0gdGhpcy5vcHRpb25zLmRhdGFbJGV2ZW50LmN1cnJlbnRUYXJnZXQub3B0aW9ucy5zZWxlY3RlZEluZGV4IC0gMV07XG4gICAgY29uc3QgZW1pdFBheWxvYWQgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRoaXMub3B0aW9ucykpO1xuICAgIGVtaXRQYXlsb2FkWydkYXRhJ10gPSBzZWxlY3RlZE9iamVjdDtcbiAgICBlbWl0UGF5bG9hZFsnc2VsZWN0ZWRMYWJlbCddID0gc2VsZWN0ZWRPYmplY3QubGFiZWw7XG4gICAgZW1pdFBheWxvYWRbJ3NlbGVjdGVkVmFsdWUnXSA9IHNlbGVjdGVkT2JqZWN0LnZhbHVlO1xuICAgIHRoaXMub25DaGFuZ2VGaWx0ZXIuZW1pdChlbWl0UGF5bG9hZCk7XG4gIH1cblxuICBmZXRjaEFzc29jaWF0aW9ucygpIHtcbiAgICAvLyAmJiB0aGlzLmNvbnRleHQudmFsdWUgJiYgdGhpcy5maWVsZC5hc3NvY2lhdGlvblxuICAgIGlmICghXy5pc0VtcHR5KHRoaXMuZGVwZW5kcykpIHtcbiAgICAgIGNvbnN0IGZpbHRlcmVkVGVybSA9IF8uZmluZCh0aGlzLmRlcGVuZGVuY3lUZXJtcywgdGVybXMgPT4ge1xuICAgICAgICByZXR1cm4gXy5pbmNsdWRlcyh0aGlzLmdldFBhcmVudFZhbHVlKCksIHRlcm1zLmlkZW50aWZpZXIpO1xuICAgICAgfSk7XG4gICAgICBpZiAoZmlsdGVyZWRUZXJtKSB7XG4gICAgICAgIHRoaXMudGVtcEFzc29jaWF0aW9uID0gIF8uZmlsdGVyKGZpbHRlcmVkVGVybS5hc3NvY2lhdGlvbnMsIGFzc29jaWF0aW9uID0+IHtcbiAgICAgICAgICByZXR1cm4gYXNzb2NpYXRpb24uY2F0ZWdvcnkgPT09IHRoaXMuZmllbGQuY29kZTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiB0aGlzLnRlbXBBc3NvY2lhdGlvbjtcbiAgICAgIH0gZWxzZSAge1xuICAgICAgICByZXR1cm4gdGhpcy5vcHRpb25zO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy5vcHRpb25zO1xuICAgIH1cbiAgfVxuXG5cbiAgZ2V0UGFyZW50VmFsdWUoKSB7XG4gICAgcmV0dXJuIHRoaXMubGF0ZXN0UGFyZW50VmFsdWUgfHwgXy5jb21wYWN0KF8ubWFwKHRoaXMuZGVwZW5kcywgJ3ZhbHVlJykpO1xuICB9XG59XG4iXX0=