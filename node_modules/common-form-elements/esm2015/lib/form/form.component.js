/**
 * @fileoverview added by tsickle
 * Generated from: lib/form/form.component.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, EventEmitter, Input, Output } from '@angular/core';
import { FieldConfigInputType, FieldConfigValidationType } from '../common-form-config';
import { FormBuilder, FormGroup, Validators } from '@angular/forms';
import { Subject } from 'rxjs';
import { distinctUntilChanged, map, scan, tap } from 'rxjs/operators';
export class FormComponent {
    /**
     * @param {?} formBuilder
     */
    constructor(formBuilder) {
        this.formBuilder = formBuilder;
        this.initialize = new EventEmitter();
        this.finalize = new EventEmitter();
        this.linkClicked = new EventEmitter();
        this.valueChanges = new EventEmitter();
        this.statusChanges = new EventEmitter();
        this.platform = 'web';
        this.dataLoadStatus = new EventEmitter();
        this.dataLoadStatusDelegate = new Subject();
        this.FieldConfigInputType = FieldConfigInputType;
        if (!window['forms']) {
            window['forms'] = [];
        }
        window['forms'].push(this);
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.finalize.emit();
        if (this.statusChangesSubscription) {
            this.statusChangesSubscription.unsubscribe();
        }
        if (this.valueChangesSubscription) {
            this.valueChangesSubscription.unsubscribe();
        }
        if (this.dataLoadStatusSinkSubscription) {
            this.dataLoadStatusSinkSubscription.unsubscribe();
        }
    }
    /**
     * @return {?}
     */
    ngOnInit() {
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    ngOnChanges(changes) {
        if (changes['config']) {
            if ((changes['config'].currentValue && changes['config'].firstChange) || changes['config'].previousValue !== changes['config'].currentValue) {
                this.initializeForm();
            }
        }
        if (this.dataLoadStatusSinkSubscription) {
            this.dataLoadStatusSinkSubscription.unsubscribe();
        }
        if (this.statusChangesSubscription) {
            this.statusChangesSubscription.unsubscribe();
        }
        if (this.valueChangesSubscription) {
            this.valueChangesSubscription.unsubscribe();
        }
        this.dataLoadStatusSinkSubscription = this.dataLoadStatusDelegate.pipe(scan((/**
         * @param {?} acc
         * @param {?} event
         * @return {?}
         */
        (acc, event) => {
            if (event === 'LOADED') {
                acc.loadedCount++;
                return acc;
            }
            acc.loadingCount++;
            return acc;
        }), { loadingCount: 0, loadedCount: 0 }), map((/**
         * @param {?} aggregates
         * @return {?}
         */
        (aggregates) => {
            if (aggregates.loadingCount !== aggregates.loadedCount) {
                return 'LOADING';
            }
            return 'LOADED';
        })), distinctUntilChanged(), tap((/**
         * @param {?} result
         * @return {?}
         */
        (result) => {
            if (result === 'LOADING') {
                this.dataLoadStatus.emit('LOADING');
            }
            else {
                this.dataLoadStatus.emit('LOADED');
            }
        }))).subscribe();
        this.statusChangesSubscription = this.formGroup.statusChanges.pipe(tap((/**
         * @param {?} v
         * @return {?}
         */
        (v) => {
            this.statusChanges.emit({
                isPristine: this.formGroup.pristine,
                isDirty: this.formGroup.dirty,
                isInvalid: this.formGroup.invalid,
                isValid: this.formGroup.valid
            });
        }))).subscribe();
        this.valueChangesSubscription = this.formGroup.valueChanges.pipe(tap((/**
         * @param {?} v
         * @return {?}
         */
        (v) => {
            this.valueChanges.emit(v);
        }))).subscribe();
    }
    /**
     * @param {?} nestedFormGroup
     * @param {?} fieldConfig
     * @return {?}
     */
    onNestedFormFinalize(nestedFormGroup, fieldConfig) {
        if (!this.formGroup.get('children') || !this.formGroup.get(`children.${fieldConfig.code}`)) {
            return;
        }
        ((/** @type {?} */ (this.formGroup.get('children')))).removeControl(fieldConfig.code);
        if (!Object.keys(((/** @type {?} */ (this.formGroup.get('children')))).controls).length) {
            this.formGroup.removeControl('children');
        }
    }
    /**
     * @param {?} nestedFormGroup
     * @param {?} fieldConfig
     * @return {?}
     */
    onNestedFormInitialize(nestedFormGroup, fieldConfig) {
        if (!this.formGroup.get('children')) {
            this.formGroup.addControl('children', new FormGroup({}));
        }
        ((/** @type {?} */ (this.formGroup.get('children')))).removeControl(fieldConfig.code);
        ((/** @type {?} */ (this.formGroup.get('children')))).addControl(fieldConfig.code, nestedFormGroup);
    }
    /**
     * @private
     * @return {?}
     */
    initializeForm() {
        if (!this.config.length) {
            console.error('FORM LIST IS EMPTY');
            return;
        }
        /** @type {?} */
        const formGroupData = {};
        this.config.forEach((/**
         * @param {?} element
         * @param {?} index
         * @return {?}
         */
        (element, index) => {
            if (element.type !== FieldConfigInputType.LABEL) {
                /** @type {?} */
                const formValueList = this.prepareFormValidationData(element, index);
                formGroupData[element.code] = formValueList;
            }
        }));
        this.formGroup = this.formBuilder.group(formGroupData);
        this.initialize.emit(this.formGroup);
    }
    /**
     * @private
     * @param {?} element
     * @param {?} index
     * @return {?}
     */
    prepareFormValidationData(element, index) {
        /** @type {?} */
        const formValueList = [];
        /** @type {?} */
        const validationList = [];
        /** @type {?} */
        let defaultVal = '';
        switch (element.type) {
            case FieldConfigInputType.INPUT:
                defaultVal = element.templateOptions.type === 'number' ?
                    (element.default && Number.isInteger(element.default) ? element.default : 0) :
                    (element.default && (typeof element.default) === 'string' ? element.default : '');
                break;
            case FieldConfigInputType.SELECT:
            case FieldConfigInputType.NESTED_SELECT:
                defaultVal = element.templateOptions.multiple ?
                    (element.default && Array.isArray(element.default) ? element.default : []) : (element.default || null);
                break;
            case FieldConfigInputType.CHECKBOX:
                defaultVal = false || !!element.default;
                break;
        }
        formValueList.push(defaultVal);
        if (element.validations && element.validations.length) {
            element.validations.forEach((/**
             * @param {?} data
             * @param {?} i
             * @return {?}
             */
            (data, i) => {
                switch (data.type) {
                    case FieldConfigValidationType.REQUIRED:
                        if (element.type === FieldConfigInputType.CHECKBOX) {
                            validationList.push(Validators.requiredTrue);
                        }
                        else if (element.type === FieldConfigInputType.SELECT || element.type === FieldConfigInputType.NESTED_SELECT) {
                            validationList.push((/**
                             * @param {?} c
                             * @return {?}
                             */
                            (c) => {
                                if (element.templateOptions.multiple) {
                                    return c.value && c.value.length ? null : 'error';
                                }
                                return !!c.value ? null : 'error';
                            }));
                        }
                        else {
                            validationList.push(Validators.required);
                        }
                        break;
                    case FieldConfigValidationType.PATTERN:
                        validationList.push(Validators.pattern((/** @type {?} */ (element.validations[i].value))));
                        break;
                    case FieldConfigValidationType.MINLENGTH:
                        validationList.push(Validators.minLength((/** @type {?} */ (element.validations[i].value))));
                        break;
                    case FieldConfigValidationType.MAXLENGTH:
                        validationList.push(Validators.maxLength((/** @type {?} */ (element.validations[i].value))));
                        break;
                }
            }));
        }
        formValueList.push(Validators.compose(validationList));
        return formValueList;
    }
    /**
     * @param {?} event
     * @return {?}
     */
    clickedLink(event) {
        this.linkClicked.emit(event);
    }
}
FormComponent.decorators = [
    { type: Component, args: [{
                selector: 'sb-form',
                template: "<div [formGroup]=\"formGroup\">\n  <ng-container *ngFor=\"let field of config; let index = i\">\n      <!-- <div *ngIf=\"field.type === FieldConfigInputType.SELECT && !field.templateOptions.multiple\" [hidden]=\"field.templateOptions?.hidden || null\">\n        <sb-dropdown [context]=\"field.context ? formGroup.get(field.context) : null \" [default]=\"field.default\"\n          [formControlRef]=\"formGroup.get(field.code)\" [label]=\"field.templateOptions.label\"\n          [dataLoadStatusDelegate]=\"dataLoadStatusDelegate\" [options]=\"field.templateOptions?.options\"\n          [disabled]=\"field.templateOptions?.disabled\" [placeHolder]=\"field?.templateOptions?.placeHolder\">\n        </sb-dropdown>\n      </div>\n    <div *ngIf=\"field.type === FieldConfigInputType.NESTED_SELECT\" [hidden]=\"field.templateOptions?.hidden || null\">\n      <sb-dropdown [context]=\"field.context ? formGroup.get(field.context) : null \" [default]=\"field.default\"\n        [formControlRef]=\"formGroup.get(field.code)\" [label]=\"field.templateOptions.label\"\n        [dataLoadStatusDelegate]=\"dataLoadStatusDelegate\" [options]=\"field.templateOptions?.options\"\n        [disabled]=\"field.templateOptions?.disabled\" [placeHolder]=\"field?.templateOptions?.placeHolder\">\n      </sb-dropdown>\n    </div> -->\n    <div *ngIf=\"field.type === FieldConfigInputType.SELECT || field.type === FieldConfigInputType.NESTED_SELECT\" [hidden]=\"field.templateOptions?.hidden || null\">\n      <sb-multiple-dropdown [context]=\"field.context ? formGroup.get(field.context) : null \" [default]=\"field.default\"\n        [formControlRef]=\"formGroup.get(field.code)\" [options]=\"field.templateOptions?.options\"\n        [label]=\"field.templateOptions.label\" [dataLoadStatusDelegate]=\"dataLoadStatusDelegate\"\n        [disabled]=\"field.templateOptions?.disabled\" [placeHolder]=\"field?.templateOptions?.placeHolder\" \n        [isMultiple]=\"field.templateOptions.multiple\" [labelHtml]=\"field.templateOptions.labelHtml\">\n      </sb-multiple-dropdown>\n    </div>\n    <div *ngIf=\"field.type === FieldConfigInputType.INPUT\" [hidden]=\"field.templateOptions?.hidden || null\">\n      <sb-textbox [formControlRef]=\"formGroup.get(field.code)\" [asyncValidation]=\"field.asyncValidation\" [label]=\"field.templateOptions.label\"\n        [placeholder]=\"field.templateOptions.placeHolder\" [validations]=\"field.validations\" [prefix]=\"field.templateOptions.prefix\"\n        [labelHtml]=\"field.templateOptions.labelHtml\">\n      </sb-textbox>\n    </div>\n    <div *ngIf=\"field.type === FieldConfigInputType.TEXTAREA\" [hidden]=\"field.templateOptions?.hidden || null\">\n      <sb-textarea [config]=\"field\" [formControlRef]=\"formGroup.get(field.code)\" [label]=\"field.templateOptions.label\"\n        [placeholder]=\"field.templateOptions.placeHolder\">\n      </sb-textarea>\n    </div>\n    <div *ngIf=\"field.type === FieldConfigInputType.CHECKBOX\" [hidden]=\"field.templateOptions?.hidden || null\">\n      <sb-checkbox [code]=\"field.code\" [formControlRef]=\"formGroup.get(field.code)\"\n        [label]=\"field.templateOptions.label\" [labelHtml]=\"field.templateOptions.labelHtml\" [value]=\"field.default\"\n        (clickedLink)=\"clickedLink($event)\"></sb-checkbox>\n    </div>\n    <div *ngIf=\"asyncValidatorFactory && field.asyncValidation?.trigger\">\n      <button #validationTrigger [attr.data-marker]=\"field.asyncValidation.marker\">\n        {{field.asyncValidation.trigger}}\n      </button>\n    </div>\n    <ng-container *ngIf=\"formGroup.get(field.code) as ref\">\n      <div *ngIf=\"field.type === FieldConfigInputType.NESTED_SELECT && ref && ref.value && field.children && field.children[ref.value]\">\n        <sb-form (initialize)=\"onNestedFormInitialize($event, field)\" (finalize)=\"onNestedFormFinalize($event, field)\"\n          [dataLoadStatusDelegate]=\"dataLoadStatusDelegate\" [config]=\"field.children[ref.value]\"></sb-form>\n      </div>\n\n      <div *ngIf=\"field.type === FieldConfigInputType.NESTED_GROUP && field.children\">\n        <sb-form (initialize)=\"onNestedFormInitialize($event, field)\" (finalize)=\"onNestedFormFinalize($event, field)\"\n          [dataLoadStatusDelegate]=\"dataLoadStatusDelegate\" [config]=\"field.children\"></sb-form>\n      </div>\n    </ng-container>\n\n    <ng-container *ngIf=\"field.type === FieldConfigInputType.LABEL\">\n      <label *ngIf=\"field.templateOptions?.label\">{{field.templateOptions?.label}}</label>\n      <div *ngIf=\"field.templateOptions?.labelHtml\" [innerHTML]=\"field.templateOptions?.labelHtml | transposeHtml\"></div>\n    </ng-container>\n    \n  </ng-container>\n</div>",
                styles: [""]
            }] }
];
/** @nocollapse */
FormComponent.ctorParameters = () => [
    { type: FormBuilder }
];
FormComponent.propDecorators = {
    initialize: [{ type: Output }],
    finalize: [{ type: Output }],
    linkClicked: [{ type: Output }],
    valueChanges: [{ type: Output }],
    statusChanges: [{ type: Output }],
    platform: [{ type: Input }],
    dataLoadStatus: [{ type: Output }],
    config: [{ type: Input }],
    dataLoadStatusDelegate: [{ type: Input }],
    asyncValidatorFactory: [{ type: Input }]
};
if (false) {
    /** @type {?} */
    FormComponent.prototype.initialize;
    /** @type {?} */
    FormComponent.prototype.finalize;
    /** @type {?} */
    FormComponent.prototype.linkClicked;
    /** @type {?} */
    FormComponent.prototype.valueChanges;
    /** @type {?} */
    FormComponent.prototype.statusChanges;
    /** @type {?} */
    FormComponent.prototype.platform;
    /** @type {?} */
    FormComponent.prototype.dataLoadStatus;
    /** @type {?} */
    FormComponent.prototype.config;
    /** @type {?} */
    FormComponent.prototype.dataLoadStatusDelegate;
    /** @type {?} */
    FormComponent.prototype.asyncValidatorFactory;
    /** @type {?} */
    FormComponent.prototype.formGroup;
    /** @type {?} */
    FormComponent.prototype.FieldConfigInputType;
    /**
     * @type {?}
     * @private
     */
    FormComponent.prototype.statusChangesSubscription;
    /**
     * @type {?}
     * @private
     */
    FormComponent.prototype.valueChangesSubscription;
    /**
     * @type {?}
     * @private
     */
    FormComponent.prototype.dataLoadStatusSinkSubscription;
    /**
     * @type {?}
     * @private
     */
    FormComponent.prototype.formBuilder;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9jb21tb24tZm9ybS1lbGVtZW50cy8iLCJzb3VyY2VzIjpbImxpYi9mb3JtL2Zvcm0uY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUVMLFNBQVMsRUFDVCxZQUFZLEVBQ1osS0FBSyxFQUlMLE1BQU0sRUFJUCxNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQXFDLG9CQUFvQixFQUFFLHlCQUF5QixFQUFDLE1BQU0sdUJBQXVCLENBQUM7QUFDMUgsT0FBTyxFQUFDLFdBQVcsRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDbEUsT0FBTyxFQUFDLE9BQU8sRUFBZSxNQUFNLE1BQU0sQ0FBQztBQUMzQyxPQUFPLEVBQUMsb0JBQW9CLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQU9wRSxNQUFNLE9BQU8sYUFBYTs7OztJQW9CeEIsWUFDVSxXQUF3QjtRQUF4QixnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQXBCeEIsZUFBVSxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFDaEMsYUFBUSxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFDOUIsZ0JBQVcsR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO1FBQ2pDLGlCQUFZLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUNsQyxrQkFBYSxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFDcEMsYUFBUSxHQUFxQixLQUFLLENBQUM7UUFDbEMsbUJBQWMsR0FBRyxJQUFJLFlBQVksRUFBd0IsQ0FBQztRQUUzRCwyQkFBc0IsR0FBRyxJQUFJLE9BQU8sRUFBd0IsQ0FBQztRQUt0RSx5QkFBb0IsR0FBRyxvQkFBb0IsQ0FBQztRQVMxQyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ3BCLE1BQU0sQ0FB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QUEyQzs7SUFDM0MscUNBQTRDOztJQUM1QyxzQ0FBNkM7O0lBQzdDLGlDQUE0Qzs7SUFDNUMsdUNBQW9FOztJQUNwRSwrQkFBZ0I7O0lBQ2hCLCtDQUFzRTs7SUFDdEUsOENBQXVEOztJQUV2RCxrQ0FBcUI7O0lBRXJCLDZDQUE0Qzs7Ozs7SUFFNUMsa0RBQWdEOzs7OztJQUNoRCxpREFBK0M7Ozs7O0lBQy9DLHVEQUFxRDs7Ozs7SUFHbkQsb0NBQWdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQWZ0ZXJWaWV3SW5pdCxcbiAgQ29tcG9uZW50LFxuICBFdmVudEVtaXR0ZXIsXG4gIElucHV0LFxuICBPbkNoYW5nZXMsXG4gIE9uRGVzdHJveSxcbiAgT25Jbml0LFxuICBPdXRwdXQsXG4gIFF1ZXJ5TGlzdCxcbiAgU2ltcGxlQ2hhbmdlcyxcbiAgVmlld0NoaWxkcmVuXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtBc3luY1ZhbGlkYXRvckZhY3RvcnksIEZpZWxkQ29uZmlnLCBGaWVsZENvbmZpZ0lucHV0VHlwZSwgRmllbGRDb25maWdWYWxpZGF0aW9uVHlwZX0gZnJvbSAnLi4vY29tbW9uLWZvcm0tY29uZmlnJztcbmltcG9ydCB7Rm9ybUJ1aWxkZXIsIEZvcm1Hcm91cCwgVmFsaWRhdG9yc30gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHtTdWJqZWN0LCBTdWJzY3JpcHRpb259IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtkaXN0aW5jdFVudGlsQ2hhbmdlZCwgbWFwLCBzY2FuLCB0YXB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnc2ItZm9ybScsXG4gIHRlbXBsYXRlVXJsOiAnLi9mb3JtLmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vZm9ybS5jb21wb25lbnQuY3NzJ11cbn0pXG5leHBvcnQgY2xhc3MgRm9ybUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3kge1xuICBAT3V0cHV0KCkgaW5pdGlhbGl6ZSA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgQE91dHB1dCgpIGZpbmFsaXplID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICBAT3V0cHV0KCkgbGlua0NsaWNrZWQgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIEBPdXRwdXQoKSB2YWx1ZUNoYW5nZXMgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIEBPdXRwdXQoKSBzdGF0dXNDaGFuZ2VzID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICBASW5wdXQoKSBwbGF0Zm9ybTogJ21vYmlsZScgfCAnd2ViJyA9ICd3ZWInO1xuICBAT3V0cHV0KCkgZGF0YUxvYWRTdGF0dXMgPSBuZXcgRXZlbnRFbWl0dGVyPCdMT0FESU5HJyB8ICdMT0FERUQnPigpO1xuICBASW5wdXQoKSBjb25maWc7XG4gIEBJbnB1dCgpIGRhdGFMb2FkU3RhdHVzRGVsZWdhdGUgPSBuZXcgU3ViamVjdDwnTE9BRElORycgfCAnTE9BREVEJz4oKTtcbiAgQElucHV0KCkgYXN5bmNWYWxpZGF0b3JGYWN0b3J5PzogQXN5bmNWYWxpZGF0b3JGYWN0b3J5O1xuXG4gIGZvcm1Hcm91cDogRm9ybUdyb3VwO1xuXG4gIEZpZWxkQ29uZmlnSW5wdXRUeXBlID0gRmllbGRDb25maWdJbnB1dFR5cGU7XG5cbiAgcHJpdmF0ZSBzdGF0dXNDaGFuZ2VzU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG4gIHByaXZhdGUgdmFsdWVDaGFuZ2VzU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG4gIHByaXZhdGUgZGF0YUxvYWRTdGF0dXNTaW5rU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBmb3JtQnVpbGRlcjogRm9ybUJ1aWxkZXJcbiAgKSB7XG4gICAgaWYgKCF3aW5kb3dbJ2Zvcm1zJ10pIHtcbiAgICAgIHdpbmRvd1snZm9ybXMnXSA9IFtdO1xuICAgIH1cbiAgICB3aW5kb3dbJ2Zvcm1zJ10ucHVzaCh0aGlzKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuZmluYWxpemUuZW1pdCgpO1xuXG4gICAgaWYgKHRoaXMuc3RhdHVzQ2hhbmdlc1N1YnNjcmlwdGlvbikge1xuICAgICAgdGhpcy5zdGF0dXNDaGFuZ2VzU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMudmFsdWVDaGFuZ2VzU3Vic2NyaXB0aW9uKSB7XG4gICAgICB0aGlzLnZhbHVlQ2hhbmdlc1N1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmRhdGFMb2FkU3RhdHVzU2lua1N1YnNjcmlwdGlvbikge1xuICAgICAgdGhpcy5kYXRhTG9hZFN0YXR1c1NpbmtTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICB9XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcbiAgICBpZiAoY2hhbmdlc1snY29uZmlnJ10pIHtcbiAgICAgIGlmICgoY2hhbmdlc1snY29uZmlnJ10uY3VycmVudFZhbHVlICYmIGNoYW5nZXNbJ2NvbmZpZyddLmZpcnN0Q2hhbmdlKSB8fCBjaGFuZ2VzWydjb25maWcnXS5wcmV2aW91c1ZhbHVlICE9PSBjaGFuZ2VzWydjb25maWcnXS5jdXJyZW50VmFsdWUpIHtcbiAgICAgICAgdGhpcy5pbml0aWFsaXplRm9ybSgpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICh0aGlzLmRhdGFMb2FkU3RhdHVzU2lua1N1YnNjcmlwdGlvbikge1xuICAgICAgdGhpcy5kYXRhTG9hZFN0YXR1c1NpbmtTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5zdGF0dXNDaGFuZ2VzU3Vic2NyaXB0aW9uKSB7XG4gICAgICB0aGlzLnN0YXR1c0NoYW5nZXNTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy52YWx1ZUNoYW5nZXNTdWJzY3JpcHRpb24pIHtcbiAgICAgIHRoaXMudmFsdWVDaGFuZ2VzU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuXG4gICAgdGhpcy5kYXRhTG9hZFN0YXR1c1NpbmtTdWJzY3JpcHRpb24gPSB0aGlzLmRhdGFMb2FkU3RhdHVzRGVsZWdhdGUucGlwZShcbiAgICAgIHNjYW48J0xPQURJTkcnIHwgJ0xPQURFRCcsIHsgbG9hZGluZ0NvdW50OiAwLCBsb2FkZWRDb3VudDogMCB9PigoYWNjLCBldmVudCkgPT4ge1xuICAgICAgICBpZiAoZXZlbnQgPT09ICdMT0FERUQnKSB7XG4gICAgICAgICAgYWNjLmxvYWRlZENvdW50Kys7XG4gICAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgICAgfVxuXG4gICAgICAgIGFjYy5sb2FkaW5nQ291bnQrKztcbiAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgIH0sIHtsb2FkaW5nQ291bnQ6IDAsIGxvYWRlZENvdW50OiAwfSksXG4gICAgICBtYXA8eyBsb2FkaW5nQ291bnQ6IDAsIGxvYWRlZENvdW50OiAwIH0sICdMT0FESU5HJyB8ICdMT0FERUQnPigoYWdncmVnYXRlcykgPT4ge1xuICAgICAgICBpZiAoYWdncmVnYXRlcy5sb2FkaW5nQ291bnQgIT09IGFnZ3JlZ2F0ZXMubG9hZGVkQ291bnQpIHtcbiAgICAgICAgICByZXR1cm4gJ0xPQURJTkcnO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuICdMT0FERUQnO1xuICAgICAgfSksXG4gICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpLFxuICAgICAgdGFwKChyZXN1bHQpID0+IHtcbiAgICAgICAgaWYgKHJlc3VsdCA9PT0gJ0xPQURJTkcnKSB7XG4gICAgICAgICAgdGhpcy5kYXRhTG9hZFN0YXR1cy5lbWl0KCdMT0FESU5HJyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5kYXRhTG9hZFN0YXR1cy5lbWl0KCdMT0FERUQnKTtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICApLnN1YnNjcmliZSgpO1xuXG4gICAgdGhpcy5zdGF0dXNDaGFuZ2VzU3Vic2NyaXB0aW9uID0gdGhpcy5mb3JtR3JvdXAuc3RhdHVzQ2hhbmdlcy5waXBlKFxuICAgICAgdGFwKCh2KSA9PiB7XG4gICAgICAgIHRoaXMuc3RhdHVzQ2hhbmdlcy5lbWl0KHtcbiAgICAgICAgICBpc1ByaXN0aW5lOiB0aGlzLmZvcm1Hcm91cC5wcmlzdGluZSxcbiAgICAgICAgICBpc0RpcnR5OiB0aGlzLmZvcm1Hcm91cC5kaXJ0eSxcbiAgICAgICAgICBpc0ludmFsaWQ6IHRoaXMuZm9ybUdyb3VwLmludmFsaWQsXG4gICAgICAgICAgaXNWYWxpZDogdGhpcy5mb3JtR3JvdXAudmFsaWRcbiAgICAgICAgfSk7XG4gICAgICB9KVxuICAgICkuc3Vic2NyaWJlKCk7XG5cbiAgICB0aGlzLnZhbHVlQ2hhbmdlc1N1YnNjcmlwdGlvbiA9IHRoaXMuZm9ybUdyb3VwLnZhbHVlQ2hhbmdlcy5waXBlKFxuICAgICAgdGFwKCh2KSA9PiB7XG4gICAgICAgIHRoaXMudmFsdWVDaGFuZ2VzLmVtaXQodik7XG4gICAgICB9KVxuICAgICkuc3Vic2NyaWJlKCk7XG4gIH1cblxuICBvbk5lc3RlZEZvcm1GaW5hbGl6ZShuZXN0ZWRGb3JtR3JvdXA6IEZvcm1Hcm91cCwgZmllbGRDb25maWc6IEZpZWxkQ29uZmlnPGFueT4pIHtcbiAgICBpZiAoIXRoaXMuZm9ybUdyb3VwLmdldCgnY2hpbGRyZW4nKSB8fCAhdGhpcy5mb3JtR3JvdXAuZ2V0KGBjaGlsZHJlbi4ke2ZpZWxkQ29uZmlnLmNvZGV9YCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAodGhpcy5mb3JtR3JvdXAuZ2V0KCdjaGlsZHJlbicpIGFzIEZvcm1Hcm91cCkucmVtb3ZlQ29udHJvbChmaWVsZENvbmZpZy5jb2RlKTtcblxuICAgIGlmICghT2JqZWN0LmtleXMoKHRoaXMuZm9ybUdyb3VwLmdldCgnY2hpbGRyZW4nKSBhcyBGb3JtR3JvdXApLmNvbnRyb2xzKS5sZW5ndGgpIHtcbiAgICAgIHRoaXMuZm9ybUdyb3VwLnJlbW92ZUNvbnRyb2woJ2NoaWxkcmVuJyk7XG4gICAgfVxuICB9XG5cbiAgb25OZXN0ZWRGb3JtSW5pdGlhbGl6ZShuZXN0ZWRGb3JtR3JvdXA6IEZvcm1Hcm91cCwgZmllbGRDb25maWc6IEZpZWxkQ29uZmlnPGFueT4pIHtcbiAgICBpZiAoIXRoaXMuZm9ybUdyb3VwLmdldCgnY2hpbGRyZW4nKSkge1xuICAgICAgdGhpcy5mb3JtR3JvdXAuYWRkQ29udHJvbCgnY2hpbGRyZW4nLCBuZXcgRm9ybUdyb3VwKHt9KSk7XG4gICAgfVxuXG4gICAgKHRoaXMuZm9ybUdyb3VwLmdldCgnY2hpbGRyZW4nKSBhcyBGb3JtR3JvdXApLnJlbW92ZUNvbnRyb2woZmllbGRDb25maWcuY29kZSk7XG4gICAgKHRoaXMuZm9ybUdyb3VwLmdldCgnY2hpbGRyZW4nKSBhcyBGb3JtR3JvdXApLmFkZENvbnRyb2woZmllbGRDb25maWcuY29kZSwgbmVzdGVkRm9ybUdyb3VwKTtcbiAgfVxuXG4gIHByaXZhdGUgaW5pdGlhbGl6ZUZvcm0oKSB7XG4gICAgaWYgKCF0aGlzLmNvbmZpZy5sZW5ndGgpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZPUk0gTElTVCBJUyBFTVBUWScpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBmb3JtR3JvdXBEYXRhID0ge307XG4gICAgdGhpcy5jb25maWcuZm9yRWFjaCgoZWxlbWVudDogYW55LCBpbmRleCkgPT4ge1xuICAgICAgaWYgKGVsZW1lbnQudHlwZSAhPT0gRmllbGRDb25maWdJbnB1dFR5cGUuTEFCRUwpIHtcbiAgICAgICAgY29uc3QgZm9ybVZhbHVlTGlzdCA9IHRoaXMucHJlcGFyZUZvcm1WYWxpZGF0aW9uRGF0YShlbGVtZW50LCBpbmRleCk7XG4gICAgICAgIGZvcm1Hcm91cERhdGFbZWxlbWVudC5jb2RlXSA9IGZvcm1WYWx1ZUxpc3Q7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICB0aGlzLmZvcm1Hcm91cCA9IHRoaXMuZm9ybUJ1aWxkZXIuZ3JvdXAoZm9ybUdyb3VwRGF0YSk7XG4gICAgdGhpcy5pbml0aWFsaXplLmVtaXQodGhpcy5mb3JtR3JvdXApO1xuICB9XG5cbiAgcHJpdmF0ZSBwcmVwYXJlRm9ybVZhbGlkYXRpb25EYXRhKGVsZW1lbnQ6IEZpZWxkQ29uZmlnPGFueT4sIGluZGV4KSB7XG4gICAgY29uc3QgZm9ybVZhbHVlTGlzdCA9IFtdO1xuICAgIGNvbnN0IHZhbGlkYXRpb25MaXN0ID0gW107XG5cbiAgICBsZXQgZGVmYXVsdFZhbDogYW55ID0gJyc7XG4gICAgc3dpdGNoIChlbGVtZW50LnR5cGUpIHtcbiAgICAgIGNhc2UgRmllbGRDb25maWdJbnB1dFR5cGUuSU5QVVQ6XG4gICAgICAgIGRlZmF1bHRWYWwgPSBlbGVtZW50LnRlbXBsYXRlT3B0aW9ucy50eXBlID09PSAnbnVtYmVyJyA/XG4gICAgICAgICAgKGVsZW1lbnQuZGVmYXVsdCAmJiBOdW1iZXIuaXNJbnRlZ2VyKGVsZW1lbnQuZGVmYXVsdCkgPyBlbGVtZW50LmRlZmF1bHQgOiAwKSA6XG4gICAgICAgICAgKGVsZW1lbnQuZGVmYXVsdCAmJiAodHlwZW9mIGVsZW1lbnQuZGVmYXVsdCkgPT09ICdzdHJpbmcnID8gZWxlbWVudC5kZWZhdWx0IDogJycpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgRmllbGRDb25maWdJbnB1dFR5cGUuU0VMRUNUOlxuICAgICAgY2FzZSBGaWVsZENvbmZpZ0lucHV0VHlwZS5ORVNURURfU0VMRUNUOlxuICAgICAgICBkZWZhdWx0VmFsID0gZWxlbWVudC50ZW1wbGF0ZU9wdGlvbnMubXVsdGlwbGUgP1xuICAgICAgICAgIChlbGVtZW50LmRlZmF1bHQgJiYgQXJyYXkuaXNBcnJheShlbGVtZW50LmRlZmF1bHQpID8gZWxlbWVudC5kZWZhdWx0IDogW10pIDogKGVsZW1lbnQuZGVmYXVsdCB8fCBudWxsKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIEZpZWxkQ29uZmlnSW5wdXRUeXBlLkNIRUNLQk9YOlxuICAgICAgICBkZWZhdWx0VmFsID0gZmFsc2UgfHwgISFlbGVtZW50LmRlZmF1bHQ7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cblxuICAgIGZvcm1WYWx1ZUxpc3QucHVzaChkZWZhdWx0VmFsKTtcblxuICAgIGlmIChlbGVtZW50LnZhbGlkYXRpb25zICYmIGVsZW1lbnQudmFsaWRhdGlvbnMubGVuZ3RoKSB7XG4gICAgICBlbGVtZW50LnZhbGlkYXRpb25zLmZvckVhY2goKGRhdGEsIGkpID0+IHtcbiAgICAgICAgc3dpdGNoIChkYXRhLnR5cGUpIHtcbiAgICAgICAgICBjYXNlIEZpZWxkQ29uZmlnVmFsaWRhdGlvblR5cGUuUkVRVUlSRUQ6XG4gICAgICAgICAgICBpZiAoZWxlbWVudC50eXBlID09PSBGaWVsZENvbmZpZ0lucHV0VHlwZS5DSEVDS0JPWCkge1xuICAgICAgICAgICAgICB2YWxpZGF0aW9uTGlzdC5wdXNoKFZhbGlkYXRvcnMucmVxdWlyZWRUcnVlKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZWxlbWVudC50eXBlID09PSBGaWVsZENvbmZpZ0lucHV0VHlwZS5TRUxFQ1QgfHwgZWxlbWVudC50eXBlID09PSBGaWVsZENvbmZpZ0lucHV0VHlwZS5ORVNURURfU0VMRUNUKSB7XG4gICAgICAgICAgICAgIHZhbGlkYXRpb25MaXN0LnB1c2goKGMpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudC50ZW1wbGF0ZU9wdGlvbnMubXVsdGlwbGUpIHtcbiAgICAgICAgICAgICAgICAgIHJldHVybiBjLnZhbHVlICYmIGMudmFsdWUubGVuZ3RoID8gbnVsbCA6ICdlcnJvcic7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiAhIWMudmFsdWUgPyBudWxsIDogJ2Vycm9yJztcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICB2YWxpZGF0aW9uTGlzdC5wdXNoKFZhbGlkYXRvcnMucmVxdWlyZWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSBGaWVsZENvbmZpZ1ZhbGlkYXRpb25UeXBlLlBBVFRFUk46XG4gICAgICAgICAgICB2YWxpZGF0aW9uTGlzdC5wdXNoKFZhbGlkYXRvcnMucGF0dGVybihlbGVtZW50LnZhbGlkYXRpb25zW2ldLnZhbHVlIGFzIHN0cmluZykpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSBGaWVsZENvbmZpZ1ZhbGlkYXRpb25UeXBlLk1JTkxFTkdUSDpcbiAgICAgICAgICAgIHZhbGlkYXRpb25MaXN0LnB1c2goVmFsaWRhdG9ycy5taW5MZW5ndGgoZWxlbWVudC52YWxpZGF0aW9uc1tpXS52YWx1ZSBhcyBudW1iZXIpKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgRmllbGRDb25maWdWYWxpZGF0aW9uVHlwZS5NQVhMRU5HVEg6XG4gICAgICAgICAgICB2YWxpZGF0aW9uTGlzdC5wdXNoKFZhbGlkYXRvcnMubWF4TGVuZ3RoKGVsZW1lbnQudmFsaWRhdGlvbnNbaV0udmFsdWUgYXMgbnVtYmVyKSk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgZm9ybVZhbHVlTGlzdC5wdXNoKFZhbGlkYXRvcnMuY29tcG9zZSh2YWxpZGF0aW9uTGlzdCkpO1xuXG4gICAgcmV0dXJuIGZvcm1WYWx1ZUxpc3Q7XG4gIH1cblxuICBjbGlja2VkTGluayhldmVudCkge1xuICAgIHRoaXMubGlua0NsaWNrZWQuZW1pdChldmVudCk7XG4gIH1cbn1cbiJdfQ==