/**
 * @fileoverview added by tsickle
 * Generated from: lib/dynamic-form/dynamic-form.component.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, EventEmitter, Input, Output } from '@angular/core';
import { FieldConfigInputType } from '../common-form-config';
import { FormBuilder, Validators } from '@angular/forms';
import { Subject } from 'rxjs';
import { tap } from 'rxjs/operators';
import * as _ from 'lodash-es';
var DynamicFormComponent = /** @class */ (function () {
    function DynamicFormComponent(formBuilder) {
        this.formBuilder = formBuilder;
        this.initialize = new EventEmitter();
        this.finalize = new EventEmitter();
        this.dataLoadStatusDelegate = new Subject();
        this.valueChanges = new EventEmitter();
        this.statusChanges = new EventEmitter();
        this._ = _;
        this.FieldConfigInputType = FieldConfigInputType;
        this.isSection = false;
    }
    /**
     * @return {?}
     */
    DynamicFormComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
    };
    /**
     * @param {?} changes
     * @return {?}
     */
    DynamicFormComponent.prototype.ngOnChanges = /**
     * @param {?} changes
     * @return {?}
     */
    function (changes) {
        var _this = this;
        /** @type {?} */
        var formGroupData = {};
        /** @type {?} */
        var dependency = [];
        if (changes['config']) {
            if ((changes['config'].currentValue && changes['config'].firstChange)
                || changes['config'].previousValue !== changes['config'].currentValue) {
                this.initialize.emit(this.formGroup);
            }
        }
        if (this.statusChangesSubscription) {
            this.statusChangesSubscription.unsubscribe();
        }
        if (this.valueChangesSubscription) {
            this.valueChangesSubscription.unsubscribe();
        }
        this.isSection = !_.isEmpty(_.find(this.config, 'fields'));
        if (this.isSection) {
            this.config.forEach((/**
             * @param {?} sections
             * @return {?}
             */
            function (sections) {
                sections.fields.forEach((/**
                 * @param {?} element
                 * @param {?} index
                 * @return {?}
                 */
                function (element, index) {
                    /** @type {?} */
                    var formValueList = _this.prepareFormValidationData(element, index);
                    if (!_.isEmpty(element.depends)) {
                        dependency.push({ code: element.code, depends: element.depends });
                    }
                    formGroupData[element.code] = formValueList;
                }));
            }));
        }
        else {
            /** @type {?} */
            var defaultSection = [];
            defaultSection = [
                {
                    'name': '',
                    'fields': _.cloneDeep(this.config)
                }
            ];
            this.config = _.cloneDeep(defaultSection);
            defaultSection.forEach((/**
             * @param {?} sections
             * @return {?}
             */
            function (sections) {
                sections.fields.forEach((/**
                 * @param {?} element
                 * @param {?} index
                 * @return {?}
                 */
                function (element, index) {
                    /** @type {?} */
                    var formValueList = _this.prepareFormValidationData(element, index);
                    if (!_.isEmpty(element.depends)) {
                        dependency.push({ code: element.code, depends: element.depends });
                    }
                    formGroupData[element.code] = formValueList;
                }));
            }));
        }
        this.flattenSectionFields = this.getFlattenedSectionFields();
        this.formGroup = this.formBuilder.group(formGroupData);
        this.statusChangesSubscription = this.formGroup.valueChanges.pipe(tap((/**
         * @param {?} v
         * @return {?}
         */
        function (v) {
            _this.statusChanges.emit({
                isPristine: _this.formGroup.pristine,
                isDirty: _this.formGroup.dirty,
                isInvalid: _this.formGroup.invalid,
                isValid: _this.formGroup.valid,
                controls: _this.getFormValidationErrors()
            });
        }))).subscribe();
        this.valueChangesSubscription = this.formGroup.valueChanges.pipe(tap((/**
         * @param {?} data
         * @return {?}
         */
        function (data) {
            _this.valueChanges.emit(data);
        }))).subscribe();
    };
    /**
     * @return {?}
     */
    DynamicFormComponent.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        this.finalize.emit();
        if (this.statusChangesSubscription) {
            this.statusChangesSubscription.unsubscribe();
        }
        if (this.valueChangesSubscription) {
            this.valueChangesSubscription.unsubscribe();
        }
    };
    /**
     * @return {?}
     */
    DynamicFormComponent.prototype.getFormValidationErrors = /**
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var errors = [];
        _.keys(this.formGroup.controls).forEach((/**
         * @param {?} key
         * @return {?}
         */
        function (key) {
            /** @type {?} */
            var controlErrors = _this.formGroup.get(key).errors;
            if (controlErrors != null) {
                _.keys(controlErrors).forEach((/**
                 * @param {?} keyError
                 * @return {?}
                 */
                function (keyError) {
                    errors.push({
                        control_name: key,
                        error_name: keyError,
                        error_value: controlErrors[keyError]
                    });
                }));
            }
        }));
        return errors;
    };
    /**
     * @private
     * @param {?} element
     * @param {?} index
     * @return {?}
     */
    DynamicFormComponent.prototype.prepareFormValidationData = /**
     * @private
     * @param {?} element
     * @param {?} index
     * @return {?}
     */
    function (element, index) {
        /** @type {?} */
        var formValueList = [];
        /** @type {?} */
        var validationList = [];
        /** @type {?} */
        var defaultVal = '';
        switch (element.inputType) {
            case 'text':
                defaultVal = element.default || null;
                break;
            case 'textarea':
                defaultVal = element.default || null;
                break;
            case 'select':
                if (element.default) {
                    if (element.dataType === 'list') {
                        if (_.isArray(element.default)) {
                            defaultVal = element.default;
                        }
                        else {
                            defaultVal = _.toArray(element.default);
                        }
                    }
                    else if (element.dataType === 'text') {
                        if (_.isString(element.default)) {
                            defaultVal = element.default;
                        }
                        else {
                            defaultVal = _.toString(element.default);
                        }
                    }
                }
                else {
                    defaultVal = null;
                }
                break;
            case 'multiselect':
                if (element.default) {
                    if (element.dataType === 'list' && _.isArray(element.default)) {
                        defaultVal = element.default;
                    }
                    else if (element.dataType === 'list' && _.isString(element.default)) {
                        if (_.includes(element.default, ',')) {
                            defaultVal = _.split(element.default, ',');
                        }
                        else {
                            defaultVal = [element.default];
                        }
                    }
                    else if (element.dataType === 'text') {
                        if (_.includes(element.default, ',')) {
                            defaultVal = _.split(element.default, ',');
                        }
                        else {
                            defaultVal = [element.default];
                        }
                    }
                }
                else {
                    defaultVal = [];
                }
                break;
            case 'nestedselect':
                defaultVal = element.dataType === 'list' ?
                    (element.default && Array.isArray(element.default) ? element.default :
                        _.isEmpty(element.default) ? [] : [element.default]) :
                    (element.default || null);
                break;
            case 'checkbox':
                defaultVal = (element.dataType === 'text') ? (element.default === 'Yes' ? 'Yes' : 'No') : !!element.default;
                break;
        }
        formValueList.push(defaultVal);
        if (element.validations && element.validations.length) {
            element.validations.forEach((/**
             * @param {?} data
             * @param {?} i
             * @return {?}
             */
            function (data, i) {
                switch (data.type) {
                    case 'required':
                        if (element.inputType === 'select' || element.inputType === 'multiselect' || element.inputType === 'nestedselect') {
                            validationList.push(Validators.required);
                        }
                        else if (element.type === 'checkbox') {
                            validationList.push(Validators.requiredTrue);
                        }
                        else {
                            validationList.push(Validators.required);
                        }
                        break;
                    case 'pattern':
                        validationList.push(Validators.pattern((/** @type {?} */ (element.validations[i].value))));
                        break;
                    case 'min':
                        validationList.push(Validators.minLength((/** @type {?} */ (element.validations[i].value))));
                        break;
                    case 'max':
                        validationList.push(Validators.maxLength((/** @type {?} */ (element.validations[i].value))));
                        break;
                }
            }));
        }
        formValueList.push(Validators.compose(validationList));
        return formValueList;
    };
    /**
     * @param {?} config
     * @param {?} context
     * @return {?}
     */
    DynamicFormComponent.prototype.fetchContextTerms = /**
     * @param {?} config
     * @param {?} context
     * @return {?}
     */
    function (config, context) {
        return _.get(_.find(config, { 'code': context }), 'terms') || null;
    };
    /**
     * @param {?} code
     * @param {?} depends
     * @return {?}
     */
    DynamicFormComponent.prototype.getAllDependsFormControl = /**
     * @param {?} code
     * @param {?} depends
     * @return {?}
     */
    function (code, depends) {
        var _this = this;
        /** @type {?} */
        var fieldDepends = {};
        _.forEach(depends, (/**
         * @param {?} depend
         * @return {?}
         */
        function (depend) {
            if (_this.formGroup.get(depend)) {
                fieldDepends[depend] = _this.formGroup.get(depend);
            }
        }));
        return fieldDepends || null;
    };
    /**
     * @param {?} code
     * @param {?} depends
     * @return {?}
     */
    DynamicFormComponent.prototype.fetchDependencyTerms = /**
     * @param {?} code
     * @param {?} depends
     * @return {?}
     */
    function (code, depends) {
        /** @type {?} */
        var dependsTerms = _.map(_.filter(this.flattenSectionFields, (/**
         * @param {?} c
         * @return {?}
         */
        function (c) {
            return _.includes(depends, c.code);
        })), (/**
         * @param {?} depend
         * @return {?}
         */
        function (depend) {
            return depend.terms || depend.range;
        }));
        return _.flatten(dependsTerms);
    };
    /**
     * @param {?} config
     * @param {?} val
     * @return {?}
     */
    DynamicFormComponent.prototype.getAppIcon = /**
     * @param {?} config
     * @param {?} val
     * @return {?}
     */
    function (config, val) {
        if (val) {
            return config.filter((/**
             * @param {?} field
             * @return {?}
             */
            function (field) {
                return field.code === 'appicon';
            }));
        }
        else {
            return config.filter((/**
             * @param {?} field
             * @return {?}
             */
            function (field) {
                return field.code !== 'appicon';
            }));
        }
    };
    /**
     * @param {?} config
     * @return {?}
     */
    DynamicFormComponent.prototype.groupBySection = /**
     * @param {?} config
     * @return {?}
     */
    function (config) {
        /** @type {?} */
        var fields = this.getAppIcon(config, false);
        return _.groupBy(fields, 'section.index');
    };
    /**
     * @return {?}
     */
    DynamicFormComponent.prototype.getFlattenedSectionFields = /**
     * @return {?}
     */
    function () {
        return _.flatten(_.map(this.config, 'fields'));
    };
    DynamicFormComponent.decorators = [
        { type: Component, args: [{
                    selector: 'sb-dynamic-form',
                    template: "\n<div class=\"dynamic-form\" [formGroup]=\"formGroup\">\n  <div *ngFor=\"let section of config\" class=\"formSection grid two-column-grid\">\n      <ng-container *ngFor=\"let field of section['fields']\" sbDynamicField\n      [depends]=\"getAllDependsFormControl(field.code, field.depends)\" [dependencyTerms]=\"field.depends ? fetchDependencyTerms(field.code, field.depends) : []\"\n      [context]=\"field.context ? formGroup.get(field.context) : null\" [contextTerms]=\"fetchContextTerms(config, field.context)\"\n      [options]=\"field.terms\" [field]=\"field\" [formGroup]=\"formGroup\" [default]=\"field.default || ''\" [label]=\"field.label\" [formControlRef]=\"formGroup.get(field.code)\"\n      [dataLoadStatusDelegate]=\"dataLoadStatusDelegate\" [placeholder]=\"field.placeholder || ''\" [validations]=\"field.validations || []\"\n      [disabled]=\"field.editable === true ? false : true\">\n    </ng-container>\n  </div>\n</div>\n\n",
                    styles: [""]
                }] }
    ];
    /** @nocollapse */
    DynamicFormComponent.ctorParameters = function () { return [
        { type: FormBuilder }
    ]; };
    DynamicFormComponent.propDecorators = {
        config: [{ type: Input }],
        initialize: [{ type: Output }],
        finalize: [{ type: Output }],
        dataLoadStatusDelegate: [{ type: Input }],
        valueChanges: [{ type: Output }],
        statusChanges: [{ type: Output }]
    };
    return DynamicFormComponent;
}());
export { DynamicFormComponent };
if (false) {
    /** @type {?} */
    DynamicFormComponent.prototype.config;
    /** @type {?} */
    DynamicFormComponent.prototype.initialize;
    /** @type {?} */
    DynamicFormComponent.prototype.finalize;
    /** @type {?} */
    DynamicFormComponent.prototype.dataLoadStatusDelegate;
    /** @type {?} */
    DynamicFormComponent.prototype.valueChanges;
    /** @type {?} */
    DynamicFormComponent.prototype.statusChanges;
    /**
     * @type {?}
     * @private
     */
    DynamicFormComponent.prototype.statusChangesSubscription;
    /**
     * @type {?}
     * @private
     */
    DynamicFormComponent.prototype.valueChangesSubscription;
    /** @type {?} */
    DynamicFormComponent.prototype._;
    /** @type {?} */
    DynamicFormComponent.prototype.formGroup;
    /** @type {?} */
    DynamicFormComponent.prototype.FieldConfigInputType;
    /** @type {?} */
    DynamicFormComponent.prototype.fieldDependency;
    /** @type {?} */
    DynamicFormComponent.prototype.isSection;
    /** @type {?} */
    DynamicFormComponent.prototype.flattenSectionFields;
    /**
     * @type {?}
     * @private
     */
    DynamicFormComponent.prototype.formBuilder;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pYy1mb3JtLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2NvbW1vbi1mb3JtLWVsZW1lbnRzLyIsInNvdXJjZXMiOlsibGliL2R5bmFtaWMtZm9ybS9keW5hbWljLWZvcm0uY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFpQixTQUFTLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFDcEQsTUFBTSxFQUEwQyxNQUFNLGVBQWUsQ0FBQztBQUN0RSxPQUFPLEVBQXFDLG9CQUFvQixFQUEyQyxNQUFNLHVCQUF1QixDQUFDO0FBQzNJLE9BQU8sRUFBQyxXQUFXLEVBQTBCLFVBQVUsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQy9FLE9BQU8sRUFBQyxPQUFPLEVBQWUsTUFBTSxNQUFNLENBQUM7QUFDM0MsT0FBTyxFQUFrQyxHQUFHLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUNwRSxPQUFPLEtBQUssQ0FBQyxNQUFNLFdBQVcsQ0FBQztBQUUvQjtJQTJCRSw4QkFDVSxXQUF3QjtRQUF4QixnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQXJCeEIsZUFBVSxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFDaEMsYUFBUSxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFFL0IsMkJBQXNCLEdBQUcsSUFBSSxPQUFPLEVBQXdCLENBQUM7UUFFNUQsaUJBQVksR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO1FBQ2xDLGtCQUFhLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQU03QyxNQUFDLEdBQVEsQ0FBQyxDQUFDO1FBR1gseUJBQW9CLEdBQUcsb0JBQW9CLENBQUM7UUFFNUMsY0FBUyxHQUFHLEtBQUssQ0FBQztJQUtkLENBQUM7Ozs7SUFFTCx1Q0FBUTs7O0lBQVI7SUFFQSxDQUFDOzs7OztJQUVELDBDQUFXOzs7O0lBQVgsVUFBWSxPQUFzQjtRQUFsQyxpQkFxRUM7O1lBcEVPLGFBQWEsR0FBRyxFQUFFOztZ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RXhDLHNEQUFzRTs7SUFFdEUsNENBQTRDOztJQUM1Qyw2Q0FBNkM7Ozs7O0lBRTdDLHlEQUFnRDs7Ozs7SUFDaEQsd0RBQStDOztJQUcvQyxpQ0FBVzs7SUFFWCx5Q0FBcUI7O0lBQ3JCLG9EQUE0Qzs7SUFDNUMsK0NBQW9COztJQUNwQix5Q0FBa0I7O0lBQ2xCLG9EQUFxQjs7Ozs7SUFHbkIsMkNBQWdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQWZ0ZXJWaWV3SW5pdCwgQ29tcG9uZW50LCBFdmVudEVtaXR0ZXIsIElucHV0LCBPbkNoYW5nZXMsIE9uRGVzdHJveSwgT25Jbml0LFxuICBPdXRwdXQsIFF1ZXJ5TGlzdCwgU2ltcGxlQ2hhbmdlcywgVmlld0NoaWxkcmVuIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG4gIGltcG9ydCB7QXN5bmNWYWxpZGF0b3JGYWN0b3J5LCBGaWVsZENvbmZpZywgRmllbGRDb25maWdJbnB1dFR5cGUsIEZpZWxkQ29uZmlnVmFsaWRhdGlvblR5cGUsIFNlY3Rpb25Db25maWd9IGZyb20gJy4uL2NvbW1vbi1mb3JtLWNvbmZpZyc7XG5pbXBvcnQge0Zvcm1CdWlsZGVyLCBGb3JtQ29udHJvbCwgRm9ybUdyb3VwLCBWYWxpZGF0b3JzfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5pbXBvcnQge1N1YmplY3QsIFN1YnNjcmlwdGlvbn0gZnJvbSAncnhqcyc7XG5pbXBvcnQge2Rpc3RpbmN0VW50aWxDaGFuZ2VkLCBtYXAsIHNjYW4sIHRhcH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0ICogYXMgXyBmcm9tICdsb2Rhc2gtZXMnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdzYi1keW5hbWljLWZvcm0nLFxuICB0ZW1wbGF0ZVVybDogJy4vZHluYW1pYy1mb3JtLmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vZHluYW1pYy1mb3JtLmNvbXBvbmVudC5jc3MnXVxufSlcbmV4cG9ydCBjbGFzcyBEeW5hbWljRm9ybUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3kgIHtcbiAgQElucHV0KCkgY29uZmlnO1xuICBAT3V0cHV0KCkgaW5pdGlhbGl6ZSA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgQE91dHB1dCgpIGZpbmFsaXplID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gIEBJbnB1dCgpIGRhdGFMb2FkU3RhdHVzRGVsZWdhdGUgPSBuZXcgU3ViamVjdDwnTE9BRElORycgfCAnTE9BREVEJz4oKTtcblxuICBAT3V0cHV0KCkgdmFsdWVDaGFuZ2VzID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICBAT3V0cHV0KCkgc3RhdHVzQ2hhbmdlcyA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICBwcml2YXRlIHN0YXR1c0NoYW5nZXNTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcbiAgcHJpdmF0ZSB2YWx1ZUNoYW5nZXNTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcblxuXG4gIF86IGFueSA9IF87XG5cbiAgZm9ybUdyb3VwOiBGb3JtR3JvdXA7XG4gIEZpZWxkQ29uZmlnSW5wdXRUeXBlID0gRmllbGRDb25maWdJbnB1dFR5cGU7XG4gIGZpZWxkRGVwZW5kZW5jeToge307XG4gIGlzU2VjdGlvbiA9IGZhbHNlO1xuICBmbGF0dGVuU2VjdGlvbkZpZWxkcztcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGZvcm1CdWlsZGVyOiBGb3JtQnVpbGRlclxuICApIHsgfVxuXG4gIG5nT25Jbml0KCkge1xuXG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XG4gICAgY29uc3QgZm9ybUdyb3VwRGF0YSA9IHt9O1xuICAgIGNvbnN0IGRlcGVuZGVuY3kgPSBbXTtcbiAgICBpZiAoY2hhbmdlc1snY29uZmlnJ10pIHtcbiAgICAgIGlmICgoY2hhbmdlc1snY29uZmlnJ10uY3VycmVudFZhbHVlICYmIGNoYW5nZXNbJ2NvbmZpZyddLmZpcnN0Q2hhbmdlKVxuICAgICAgfHwgY2hhbmdlc1snY29uZmlnJ10ucHJldmlvdXNWYWx1ZSAhPT0gY2hhbmdlc1snY29uZmlnJ10uY3VycmVudFZhbHVlKSB7XG4gICAgICAgIHRoaXMuaW5pdGlhbGl6ZS5lbWl0KHRoaXMuZm9ybUdyb3VwKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAodGhpcy5zdGF0dXNDaGFuZ2VzU3Vic2NyaXB0aW9uKSB7XG4gICAgICB0aGlzLnN0YXR1c0NoYW5nZXNTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy52YWx1ZUNoYW5nZXNTdWJzY3JpcHRpb24pIHtcbiAgICAgIHRoaXMudmFsdWVDaGFuZ2VzU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuXG4gICAgdGhpcy5pc1NlY3Rpb24gPSAhXy5pc0VtcHR5KF8uZmluZCh0aGlzLmNvbmZpZywgJ2ZpZWxkcycpKTtcbiAgICBpZiAodGhpcy5pc1NlY3Rpb24pIHtcbiAgICAgIHRoaXMuY29uZmlnLmZvckVhY2goKHNlY3Rpb25zKSA9PiB7XG4gICAgICAgICAgc2VjdGlvbnMuZmllbGRzLmZvckVhY2goKGVsZW1lbnQ6IGFueSwgaW5kZXgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGZvcm1WYWx1ZUxpc3QgPSB0aGlzLnByZXBhcmVGb3JtVmFsaWRhdGlvbkRhdGEoZWxlbWVudCwgaW5kZXgpO1xuICAgICAgICAgIGlmICghXy5pc0VtcHR5KGVsZW1lbnQuZGVwZW5kcykpIHtcbiAgICAgICAgICAgIGRlcGVuZGVuY3kucHVzaCh7Y29kZTogZWxlbWVudC5jb2RlLCBkZXBlbmRzOiBlbGVtZW50LmRlcGVuZHN9KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgZm9ybUdyb3VwRGF0YVtlbGVtZW50LmNvZGVdID0gZm9ybVZhbHVlTGlzdDtcbiAgICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBsZXQgZGVmYXVsdFNlY3Rpb246IGFueSA9IFtdO1xuICAgICAgZGVmYXVsdFNlY3Rpb24gPSBbXG4gICAgICAgIHtcbiAgICAgICAgICAnbmFtZSc6ICcnLFxuICAgICAgICAgICdmaWVsZHMnOiBfLmNsb25lRGVlcCh0aGlzLmNvbmZpZylcbiAgICAgICAgfVxuICAgICAgXTtcblxuICAgICAgdGhpcy5jb25maWcgPSBfLmNsb25lRGVlcChkZWZhdWx0U2VjdGlvbik7XG4gICAgICBkZWZhdWx0U2VjdGlvbi5mb3JFYWNoKChzZWN0aW9ucykgPT4ge1xuICAgICAgICBzZWN0aW9ucy5maWVsZHMuZm9yRWFjaCgoZWxlbWVudDogYW55LCBpbmRleCkgPT4ge1xuICAgICAgICAgIGNvbnN0IGZvcm1WYWx1ZUxpc3QgPSB0aGlzLnByZXBhcmVGb3JtVmFsaWRhdGlvbkRhdGEoZWxlbWVudCwgaW5kZXgpO1xuICAgICAgICBpZiAoIV8uaXNFbXB0eShlbGVtZW50LmRlcGVuZHMpKSB7XG4gICAgICAgICAgZGVwZW5kZW5jeS5wdXNoKHtjb2RlOiBlbGVtZW50LmNvZGUsIGRlcGVuZHM6IGVsZW1lbnQuZGVwZW5kc30pO1xuICAgICAgICB9XG4gICAgICAgIGZvcm1Hcm91cERhdGFbZWxlbWVudC5jb2RlXSA9IGZvcm1WYWx1ZUxpc3Q7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICAgIH1cbiAgICB0aGlzLmZsYXR0ZW5TZWN0aW9uRmllbGRzID0gdGhpcy5nZXRGbGF0dGVuZWRTZWN0aW9uRmllbGRzKCk7XG4gICAgdGhpcy5mb3JtR3JvdXAgPSB0aGlzLmZvcm1CdWlsZGVyLmdyb3VwKGZvcm1Hcm91cERhdGEpO1xuXG4gICAgdGhpcy5zdGF0dXNDaGFuZ2VzU3Vic2NyaXB0aW9uID0gdGhpcy5mb3JtR3JvdXAudmFsdWVDaGFuZ2VzLnBpcGUoXG4gICAgICB0YXAoKHYpID0+IHtcbiAgICAgICAgdGhpcy5zdGF0dXNDaGFuZ2VzLmVtaXQoe1xuICAgICAgICAgIGlzUHJpc3RpbmU6IHRoaXMuZm9ybUdyb3VwLnByaXN0aW5lLFxuICAgICAgICAgIGlzRGlydHk6IHRoaXMuZm9ybUdyb3VwLmRpcnR5LFxuICAgICAgICAgIGlzSW52YWxpZDogdGhpcy5mb3JtR3JvdXAuaW52YWxpZCxcbiAgICAgICAgICBpc1ZhbGlkOiB0aGlzLmZvcm1Hcm91cC52YWxpZCxcbiAgICAgICAgICBjb250cm9sczogdGhpcy5nZXRGb3JtVmFsaWRhdGlvbkVycm9ycygpXG4gICAgICAgIH0pO1xuICAgICAgfSlcbiAgICApLnN1YnNjcmliZSgpO1xuXG4gICAgdGhpcy52YWx1ZUNoYW5nZXNTdWJzY3JpcHRpb24gPSAgdGhpcy5mb3JtR3JvdXAudmFsdWVDaGFuZ2VzLnBpcGUoXG4gICAgICB0YXAoKGRhdGEpID0+IHtcbiAgICAgICAgdGhpcy52YWx1ZUNoYW5nZXMuZW1pdChkYXRhKTtcbiAgICAgIH0pXG4gICAgKS5zdWJzY3JpYmUoKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuZmluYWxpemUuZW1pdCgpO1xuXG4gICAgaWYgKHRoaXMuc3RhdHVzQ2hhbmdlc1N1YnNjcmlwdGlvbikge1xuICAgICAgdGhpcy5zdGF0dXNDaGFuZ2VzU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMudmFsdWVDaGFuZ2VzU3Vic2NyaXB0aW9uKSB7XG4gICAgICB0aGlzLnZhbHVlQ2hhbmdlc1N1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIH1cbiAgfVxuXG4gIGdldEZvcm1WYWxpZGF0aW9uRXJyb3JzKCkge1xuICAgIGNvbnN0IGVycm9ycyA9IFtdO1xuICAgIF8ua2V5cyh0aGlzLmZvcm1Hcm91cC5jb250cm9scykuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgY29uc3QgY29udHJvbEVycm9ycyA9IHRoaXMuZm9ybUdyb3VwLmdldChrZXkpLmVycm9ycztcbiAgICAgIGlmIChjb250cm9sRXJyb3JzICE9IG51bGwpIHtcbiAgICAgICAgXy5rZXlzKGNvbnRyb2xFcnJvcnMpLmZvckVhY2goa2V5RXJyb3IgPT4ge1xuICAgICAgICAgIGVycm9ycy5wdXNoKHtcbiAgICAgICAgICAgIGNvbnRyb2xfbmFtZToga2V5LFxuICAgICAgICAgICAgZXJyb3JfbmFtZToga2V5RXJyb3IsXG4gICAgICAgICAgICBlcnJvcl92YWx1ZTogY29udHJvbEVycm9yc1sga2V5RXJyb3IgXVxuICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gZXJyb3JzO1xuICB9XG5cblxuICBwcml2YXRlIHByZXBhcmVGb3JtVmFsaWRhdGlvbkRhdGEoZWxlbWVudDogYW55LCBpbmRleCkge1xuICAgIGNvbnN0IGZvcm1WYWx1ZUxpc3QgPSBbXTtcbiAgICBjb25zdCB2YWxpZGF0aW9uTGlzdCA9IFtdO1xuXG4gICAgbGV0IGRlZmF1bHRWYWw6IGFueSA9ICcnO1xuICAgIHN3aXRjaCAoZWxlbWVudC5pbnB1dFR5cGUpIHtcbiAgICAgIGNhc2UgJ3RleHQnOlxuICAgICAgICBkZWZhdWx0VmFsID0gZWxlbWVudC5kZWZhdWx0IHx8IG51bGw7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAndGV4dGFyZWEnOlxuICAgICAgICBkZWZhdWx0VmFsID0gZWxlbWVudC5kZWZhdWx0IHx8IG51bGw7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnc2VsZWN0JzpcbiAgICAgICAgaWYgKGVsZW1lbnQuZGVmYXVsdCkge1xuICAgICAgICAgIGlmIChlbGVtZW50LmRhdGFUeXBlID09PSAnbGlzdCcpIHtcbiAgICAgICAgICAgIGlmIChfLmlzQXJyYXkoZWxlbWVudC5kZWZhdWx0KSkge1xuICAgICAgICAgICAgICBkZWZhdWx0VmFsID0gZWxlbWVudC5kZWZhdWx0O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgZGVmYXVsdFZhbCA9IF8udG9BcnJheShlbGVtZW50LmRlZmF1bHQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSBpZiAoZWxlbWVudC5kYXRhVHlwZSA9PT0gJ3RleHQnKSB7XG4gICAgICAgICAgICBpZiAoXy5pc1N0cmluZyhlbGVtZW50LmRlZmF1bHQpKSB7XG4gICAgICAgICAgICAgIGRlZmF1bHRWYWwgPSBlbGVtZW50LmRlZmF1bHQ7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBkZWZhdWx0VmFsID0gXy50b1N0cmluZyhlbGVtZW50LmRlZmF1bHQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBkZWZhdWx0VmFsID0gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ211bHRpc2VsZWN0JzpcbiAgICAgICAgICBpZiAoZWxlbWVudC5kZWZhdWx0KSB7XG4gICAgICAgICAgICBpZiAoZWxlbWVudC5kYXRhVHlwZSA9PT0gJ2xpc3QnICYmIF8uaXNBcnJheShlbGVtZW50LmRlZmF1bHQpKSB7XG4gICAgICAgICAgICAgIGRlZmF1bHRWYWwgPSBlbGVtZW50LmRlZmF1bHQ7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGVsZW1lbnQuZGF0YVR5cGUgPT09ICdsaXN0JyAmJiBfLmlzU3RyaW5nKGVsZW1lbnQuZGVmYXVsdCkpIHtcbiAgICAgICAgICAgICAgaWYgKF8uaW5jbHVkZXMoZWxlbWVudC5kZWZhdWx0LCAnLCcpKSB7XG4gICAgICAgICAgICAgICAgZGVmYXVsdFZhbCA9IF8uc3BsaXQoZWxlbWVudC5kZWZhdWx0LCAnLCcpO1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGRlZmF1bHRWYWwgPSBbZWxlbWVudC5kZWZhdWx0XTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIGlmIChlbGVtZW50LmRhdGFUeXBlID09PSAndGV4dCcpIHtcbiAgICAgICAgICAgICAgaWYgKF8uaW5jbHVkZXMoZWxlbWVudC5kZWZhdWx0LCAnLCcpKSB7XG4gICAgICAgICAgICAgICAgZGVmYXVsdFZhbCA9IF8uc3BsaXQoZWxlbWVudC5kZWZhdWx0LCAnLCcpO1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGRlZmF1bHRWYWwgPSBbZWxlbWVudC5kZWZhdWx0XTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBkZWZhdWx0VmFsID0gW107XG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnbmVzdGVkc2VsZWN0JzpcbiAgICAgICAgICBkZWZhdWx0VmFsID0gZWxlbWVudC5kYXRhVHlwZSA9PT0gJ2xpc3QnID9cbiAgICAgICAgICAoZWxlbWVudC5kZWZhdWx0ICYmIEFycmF5LmlzQXJyYXkoZWxlbWVudC5kZWZhdWx0KSA/IGVsZW1lbnQuZGVmYXVsdCA6XG4gICAgICAgICAgXy5pc0VtcHR5KGVsZW1lbnQuZGVmYXVsdCkgPyBbXSA6IFtlbGVtZW50LmRlZmF1bHRdKSA6XG4gICAgICAgICAgKGVsZW1lbnQuZGVmYXVsdCB8fCBudWxsKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ2NoZWNrYm94JzpcbiAgICAgICAgZGVmYXVsdFZhbCA9IChlbGVtZW50LmRhdGFUeXBlID09PSAndGV4dCcpID8gKGVsZW1lbnQuZGVmYXVsdCA9PT0gJ1llcycgPyAnWWVzJyA6ICdObycpIDogISFlbGVtZW50LmRlZmF1bHQ7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cblxuICAgIGZvcm1WYWx1ZUxpc3QucHVzaChkZWZhdWx0VmFsKTtcblxuICAgIGlmIChlbGVtZW50LnZhbGlkYXRpb25zICYmIGVsZW1lbnQudmFsaWRhdGlvbnMubGVuZ3RoKSB7XG4gICAgICBlbGVtZW50LnZhbGlkYXRpb25zLmZvckVhY2goKGRhdGEsIGkpID0+IHtcbiAgICAgICAgc3dpdGNoIChkYXRhLnR5cGUpIHtcbiAgICAgICAgICBjYXNlICdyZXF1aXJlZCc6XG4gICAgICAgICAgICBpZiAoZWxlbWVudC5pbnB1dFR5cGUgPT09ICdzZWxlY3QnIHx8IGVsZW1lbnQuaW5wdXRUeXBlID09PSAnbXVsdGlzZWxlY3QnIHx8IGVsZW1lbnQuaW5wdXRUeXBlID09PSAnbmVzdGVkc2VsZWN0Jykge1xuICAgICAgICAgICAgICB2YWxpZGF0aW9uTGlzdC5wdXNoKFZhbGlkYXRvcnMucmVxdWlyZWQpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChlbGVtZW50LnR5cGUgPT09ICdjaGVja2JveCcpIHtcbiAgICAgICAgICAgICAgdmFsaWRhdGlvbkxpc3QucHVzaChWYWxpZGF0b3JzLnJlcXVpcmVkVHJ1ZSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICB2YWxpZGF0aW9uTGlzdC5wdXNoKFZhbGlkYXRvcnMucmVxdWlyZWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSAncGF0dGVybic6XG4gICAgICAgICAgICB2YWxpZGF0aW9uTGlzdC5wdXNoKFZhbGlkYXRvcnMucGF0dGVybihlbGVtZW50LnZhbGlkYXRpb25zW2ldLnZhbHVlIGFzIHN0cmluZykpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSAnbWluJzpcbiAgICAgICAgICAgIHZhbGlkYXRpb25MaXN0LnB1c2goVmFsaWRhdG9ycy5taW5MZW5ndGgoZWxlbWVudC52YWxpZGF0aW9uc1tpXS52YWx1ZSBhcyBudW1iZXIpKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgJ21heCc6XG4gICAgICAgICAgICB2YWxpZGF0aW9uTGlzdC5wdXNoKFZhbGlkYXRvcnMubWF4TGVuZ3RoKGVsZW1lbnQudmFsaWRhdGlvbnNbaV0udmFsdWUgYXMgbnVtYmVyKSk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgZm9ybVZhbHVlTGlzdC5wdXNoKFZhbGlkYXRvcnMuY29tcG9zZSh2YWxpZGF0aW9uTGlzdCkpO1xuXG4gICAgcmV0dXJuIGZvcm1WYWx1ZUxpc3Q7XG4gIH1cblxuXG4gIGZldGNoQ29udGV4dFRlcm1zKGNvbmZpZzogRmllbGRDb25maWc8YW55PiwgY29udGV4dCkge1xuICAgIHJldHVybiBfLmdldChfLmZpbmQoY29uZmlnLCB7J2NvZGUnOiBjb250ZXh0fSksICd0ZXJtcycpIHx8IG51bGw7XG4gIH1cblxuICBnZXRBbGxEZXBlbmRzRm9ybUNvbnRyb2woY29kZSwgZGVwZW5kcykge1xuICAgIGNvbnN0IGZpZWxkRGVwZW5kczogYW55ID0ge307XG4gICAgXy5mb3JFYWNoKGRlcGVuZHMsIGRlcGVuZCA9PiB7XG4gICAgICAgIGlmICh0aGlzLmZvcm1Hcm91cC5nZXQoZGVwZW5kKSkge1xuICAgICAgICAgICAgZmllbGREZXBlbmRzW2RlcGVuZF0gPSB0aGlzLmZvcm1Hcm91cC5nZXQoZGVwZW5kKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgcmV0dXJuIGZpZWxkRGVwZW5kcyB8fCBudWxsO1xuICB9XG5cbiAgZmV0Y2hEZXBlbmRlbmN5VGVybXMoY29kZSwgZGVwZW5kcykge1xuICAgIGNvbnN0IGRlcGVuZHNUZXJtcyA9IF8ubWFwKF8uZmlsdGVyKHRoaXMuZmxhdHRlblNlY3Rpb25GaWVsZHMsIGMgPT4ge1xuICAgICAgcmV0dXJuIF8uaW5jbHVkZXMoZGVwZW5kcywgYy5jb2RlKTtcbiAgICB9KSwgKGRlcGVuZCkgPT4ge1xuICAgICAgcmV0dXJuIGRlcGVuZC50ZXJtcyB8fCBkZXBlbmQucmFuZ2U7XG4gICAgfSk7XG4gICAgcmV0dXJuIF8uZmxhdHRlbihkZXBlbmRzVGVybXMpO1xuICB9XG5cbiAgZ2V0QXBwSWNvbihjb25maWcsIHZhbCkge1xuICAgIGlmICh2YWwpIHtcbiAgICAgIHJldHVybiBjb25maWcuZmlsdGVyKGZpZWxkID0+IHtcbiAgICAgICAgcmV0dXJuIGZpZWxkLmNvZGUgPT09ICdhcHBpY29uJztcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICAgcmV0dXJuIGNvbmZpZy5maWx0ZXIoZmllbGQgPT4ge1xuICAgICAgICByZXR1cm4gZmllbGQuY29kZSAhPT0gJ2FwcGljb24nO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgZ3JvdXBCeVNlY3Rpb24oY29uZmlnKSB7XG4gICAgY29uc3QgZmllbGRzID0gdGhpcy5nZXRBcHBJY29uKGNvbmZpZywgZmFsc2UpO1xuICAgIHJldHVybiBfLmdyb3VwQnkoZmllbGRzLCAnc2VjdGlvbi5pbmRleCcpO1xuICB9XG5cbiAgZ2V0RmxhdHRlbmVkU2VjdGlvbkZpZWxkcygpIHtcbiAgICByZXR1cm4gXy5mbGF0dGVuKF8ubWFwKHRoaXMuY29uZmlnLCAnZmllbGRzJykpO1xuICB9XG5cbn1cbiJdfQ==