/**
 * @fileoverview added by tsickle
 * Generated from: lib/dynamic-dropdown/dynamic-dropdown.component.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Component, Input, Output, EventEmitter } from '@angular/core';
import { FormControl, FormGroup } from '@angular/forms';
import { Subject, merge } from 'rxjs';
import { tap } from 'rxjs/operators';
import * as _ from 'lodash-es';
import { ValueComparator } from '../utilities/value-comparator';
var DynamicDropdownComponent = /** @class */ (function () {
    function DynamicDropdownComponent() {
        this.ValueComparator = ValueComparator;
        this.onChangeFilter = new EventEmitter();
        this.dependencyTerms = [];
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    DynamicDropdownComponent.prototype.ngOnChanges = /**
     * @param {?} changes
     * @return {?}
     */
    function (changes) {
        var _this = this;
        if (!this.options) {
            this.options = [];
        }
        if (this.isOptionsClosure(this.options)) {
            this.options$ = (/** @type {?} */ (((/** @type {?} */ (this.options)))(this.formControlRef, this.depends, this.formGroup, (/**
             * @return {?}
             */
            function () { return _this.dataLoadStatusDelegate.next('LOADING'); }), (/**
             * @return {?}
             */
            function () { return _this.dataLoadStatusDelegate.next('LOADED'); }))));
        }
    };
    /**
     * @return {?}
     */
    DynamicDropdownComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        if (!this.options) {
            this.options = [];
        }
        // if (this.context) {
        // this.contextValueChangesSubscription = this.context.valueChanges.pipe(
        //   tap(() => {
        //     this.formControlRef.patchValue(null);
        //   })
        // ).subscribe();
        // }
        this.dataLoadStatusDelegate.subscribe(console.log);
        if (this.field && this.field.range) {
            this.options = this.field.range;
        }
        else if (_.isEmpty(this.options) && _.isEmpty(this.field.range) && this.default) {
            this.field.range = [];
            this.field.range.push(this.default);
        }
        if (!_.isEmpty(this.depends)) {
            this.contextValueChangesSubscription = merge.apply(void 0, tslib_1.__spread(_.map(this.depends, (/**
             * @param {?} depend
             * @return {?}
             */
            function (depend) { return depend.valueChanges; })))).pipe(tap((/**
             * @param {?} value
             * @return {?}
             */
            function (value) {
                _this.latestParentValue = value;
                _this.isDependsInvalid = _.includes(_.map(_this.depends, (/**
                 * @param {?} depend
                 * @return {?}
                 */
                function (depend) { return depend.invalid; })), true);
                _this.formControlRef.patchValue(null);
            }))).subscribe();
            this.isDependsInvalid = _.includes(_.map(this.depends, (/**
             * @param {?} depend
             * @return {?}
             */
            function (depend) { return depend.invalid; })), true);
        }
        if (this.isOptionsClosure(this.options)) {
            // tslint:disable-next-line:max-line-length
            this.options$ = (/** @type {?} */ (((/** @type {?} */ (this.options)))(this.formControlRef, this.depends, this.formGroup, (/**
             * @return {?}
             */
            function () { return _this.dataLoadStatusDelegate.next('LOADING'); }), (/**
             * @return {?}
             */
            function () { return _this.dataLoadStatusDelegate.next('LOADED'); }))));
        }
    };
    /**
     * @return {?}
     */
    DynamicDropdownComponent.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        if (this.contextValueChangesSubscription) {
            this.contextValueChangesSubscription.unsubscribe();
        }
    };
    /**
     * @param {?} options
     * @return {?}
     */
    DynamicDropdownComponent.prototype.isOptionsArray = /**
     * @param {?} options
     * @return {?}
     */
    function (options) {
        return Array.isArray(options);
    };
    /**
     * @param {?} options
     * @return {?}
     */
    DynamicDropdownComponent.prototype.isOptionsClosure = /**
     * @param {?} options
     * @return {?}
     */
    function (options) {
        return typeof options === 'function';
    };
    /**
     * @param {?} input
     * @return {?}
     */
    DynamicDropdownComponent.prototype.isOptionsMap = /**
     * @param {?} input
     * @return {?}
     */
    function (input) {
        return !Array.isArray(input) && typeof input === 'object';
    };
    /**
     * @param {?} input
     * @return {?}
     */
    DynamicDropdownComponent.prototype.isOptionsArrayMap = /**
     * @param {?} input
     * @return {?}
     */
    function (input) {
        return Array.isArray(input) && typeof input[0] === 'object';
    };
    /**
     * @param {?} $event
     * @return {?}
     */
    DynamicDropdownComponent.prototype.onChangeFacet = /**
     * @param {?} $event
     * @return {?}
     */
    function ($event) {
        /** @type {?} */
        var selectedObject = this.options.data[$event.currentTarget.options.selectedIndex - 1];
        /** @type {?} */
        var emitPayload = JSON.parse(JSON.stringify(this.options));
        emitPayload['data'] = selectedObject;
        emitPayload['selectedLabel'] = selectedObject.label;
        emitPayload['selectedValue'] = selectedObject.value;
        this.onChangeFilter.emit(emitPayload);
    };
    /**
     * @return {?}
     */
    DynamicDropdownComponent.prototype.fetchAssociations = /**
     * @return {?}
     */
    function () {
        var _this = this;
        // && this.context.value && this.field.association
        if (!_.isEmpty(this.depends)) {
            /** @type {?} */
            var filteredTerm = _.find(this.dependencyTerms, (/**
             * @param {?} terms
             * @return {?}
             */
            function (terms) {
                return !_.isEmpty(_this.field.output) ?
                    _.includes(_this.getParentValue(), terms[_this.field.output]) :
                    _.includes(_this.getParentValue(), terms.name);
            }));
            if (filteredTerm) {
                this.tempAssociation = _.filter(filteredTerm.associations, (/**
                 * @param {?} association
                 * @return {?}
                 */
                function (association) {
                    return (_this.field.sourceCategory) ?
                        (association.category === _this.field.sourceCategory) :
                        association.category === _this.field.code;
                }));
                return this.tempAssociation;
            }
            else {
                return this.options;
            }
        }
        else {
            return this.options;
        }
    };
    /**
     * @return {?}
     */
    DynamicDropdownComponent.prototype.getParentValue = /**
     * @return {?}
     */
    function () {
        return this.latestParentValue || _.compact(_.map(this.depends, 'value'));
    };
    /**
     * @param {?} option
     * @return {?}
     */
    DynamicDropdownComponent.prototype.getOptionValueForTerms = /**
     * @param {?} option
     * @return {?}
     */
    function (option) {
        if (this.field.output) {
            if (this.field.dataType === 'list') {
                return [option[this.field.output]];
            }
            return option[this.field.output];
        }
        else {
            return this.field.dataType === 'list' ? [option.name] : option.name;
        }
    };
    /**
     * @param {?} option
     * @param {?} optionsType
     * @return {?}
     */
    DynamicDropdownComponent.prototype.getOptionValueForRange = /**
     * @param {?} option
     * @param {?} optionsType
     * @return {?}
     */
    function (option, optionsType) {
        if (this.field.output) {
            if (this.field.dataType === 'list') {
                if (optionsType === 'map' || optionsType === 'closure') {
                    return [option[this.field.output]] || [option.value] || [option.identifier] || [option.name] || [option.label];
                }
                else {
                    return [option];
                }
            }
            else {
                if (optionsType === 'map' || optionsType === 'closure') {
                    return option[this.field.output] || option.value || option.identifier || option.name || option.label;
                }
                else {
                    return option;
                }
            }
        }
        else {
            if (this.field.dataType === 'list') {
                if (optionsType === 'map' || optionsType === 'closure') {
                    return [option.value] || [option.identifier] || [option.name] || [option.label];
                }
                else {
                    return [option];
                }
            }
            else {
                if (optionsType === 'map' || optionsType === 'closure') {
                    return option.name || option.label || option.value || option.identifier;
                }
                else {
                    return option;
                }
            }
        }
    };
    /**
     * @param {?} option
     * @param {?=} output
     * @return {?}
     */
    DynamicDropdownComponent.prototype.convertOptionToArray = /**
     * @param {?} option
     * @param {?=} output
     * @return {?}
     */
    function (option, output) {
    };
    DynamicDropdownComponent.decorators = [
        { type: Component, args: [{
                    selector: 'sb-dynamic-dropdown',
                    template: "<div class=\"sb-dropdown\" *ngIf=\"!type\">\n  <label>{{label}} {{context && 'has context'}}  {{context ?  field.context : '' }}</label>\n  <ng-container *ngIf=\"options\">\n    <div class=\"dropdown-container\">\n      <sb-icon-dropdown class=\"dropdown-icon\"></sb-icon-dropdown>\n      <!-- [attr.disabled]=\"disabled ? true : ( context ? (context.invalid ? true : null) : null )\" -->\n      <select [formControl]=\"formControlRef\"\n              [attr.disabled]=\"disabled ? true : ( depends ? (isDependsInvalid ? true : null) : null )\"\n              [compareWith]=\"ValueComparator.valueComparator\" class=\"sb-dropdown-select\" id=\"sb-dropdown\"\n              name=\"sb-dropdown\">\n        <option [defaultSelected]=\"!default\" [ngValue]=\"null\" disabled>{{placeholder}}\n        </option>\n        <ng-container *ngIf=\"field.range && isOptionsArrayMap(field.range) && !field.association\">\n          <option class=\"optionsArrayMap\" *ngFor=\"let option of field.range\" [ngValue]=\"getOptionValueForRange(option, 'map')\">{{option.label}}</option>\n        </ng-container>\n        <ng-container *ngIf=\"field.range && isOptionsArray(field.range) && !isOptionsArrayMap(field.range) && !field.association\">\n          <option class=\"optionsArray\" *ngFor=\"let option of field.range\" [ngValue]=\"getOptionValueForRange(option, 'array')\">{{option.name || option}}</option>\n        </ng-container>\n\n        <ng-container *ngIf=\"field.range && isOptionsClosure(field.range)\">\n          <option class=\"closure\" *ngFor=\"let option of options$ | async\" [ngValue]=\"getOptionValueForRange(option, 'closure')\">{{option.label}}</option>\n        </ng-container>\n\n        <!-- <ng-container *ngIf=\"isOptionsMap(options) && context && context.value && !field.association\">\n          <option *ngFor=\"let option of options[context.value]\" [ngValue]=\"option.value\">{{option.label}}</option>\n        </ng-container> -->\n\n        <ng-container *ngIf=\"!field.range && field.terms\">\n          <option class=\"optionsLast\" *ngFor=\"let option of fetchAssociations()\" [ngValue]=\"getOptionValueForTerms(option)\">{{option.name}}</option>\n        </ng-container>\n      </select>\n    </div>\n  </ng-container>\n</div>\n\n<!-- Dropdown for filters component -->\n<div class=\"sb-dropdown\" *ngIf=\"type === 'facet'\">\n  <label>{{label}}</label>\n  <ng-container *ngIf=\"options && options.data\">\n    <div class=\"dropdown-container\">\n      <sb-icon-dropdown class=\"dropdown-icon\"></sb-icon-dropdown>\n      <select [attr.disabled]=\"disabled ? true : ( context ? (context.invalid ? true : null) : null )\"\n        class=\"sb-dropdown-select\" [ngClass]=\"(styleClass ? styleClass : 'default-dropdown')\" id=\"sb-dropdown\" name=\"sb-dropdown\"\n        (change)=\"onChangeFacet($event)\" placeholder=\"placeholder\">\n        <option *ngIf=\"!default\" [disabled]=\"true\" selected>{{placeholder}}</option>\n        <option *ngFor=\"let option of options.data\" [ngValue]=\"option\" [selected]=\"options.default === option.value\">{{option.label}}</option>\n      </select>\n    </div>\n  </ng-container>\n</div>\n<ng-container *ngFor=\"let validation of validations\">\n  <div class=\"cf-error\"\n    *ngIf=\"(validation.type && (validation.type).toLowerCase() && validation.message && formControlRef.errors && formControlRef.errors[(validation.type).toLowerCase()] && (formControlRef.dirty || formControlRef.touched))\">\n    {{ validation.message }}\n  </div>\n</ng-container>\n\n<!-- Dropdown for filters component -->\n",
                    styles: ["label{display:block;padding:10px;font-size:1rem}.dropdown-icon{position:absolute;top:.5rem;right:18px;z-index:1}.dropdown-container{position:relative}select[disabled]{opacity:.3}select{-webkit-appearance:none;-moz-appearance:none;text-indent:1px;text-overflow:''}.sb-dropdown-select{opacity:.99;color:#333;font-family:\"Noto Sans\";font-size:12px;font-weight:700;letter-spacing:0;line-height:17px}.sb-dropdown{margin-bottom:8px}.placeholder select option:first-child{color:#999}.option-default{color:#333;font-weight:700;font-size:12px}.sb-dropdown select{background-color:#fff;padding:10px 20px;font-size:14px;width:100%;border:.5px solid #333}.cf-error{color:red;font-family:\"Noto Sans\";font-size:12px}"]
                }] }
    ];
    /** @nocollapse */
    DynamicDropdownComponent.ctorParameters = function () { return []; };
    DynamicDropdownComponent.propDecorators = {
        field: [{ type: Input }],
        disabled: [{ type: Input }],
        options: [{ type: Input }],
        label: [{ type: Input }],
        placeholder: [{ type: Input }],
        isMultiple: [{ type: Input }],
        context: [{ type: Input }],
        contextTerms: [{ type: Input }],
        formControlRef: [{ type: Input }],
        formGroup: [{ type: Input }],
        default: [{ type: Input }],
        contextData: [{ type: Input }],
        dataLoadStatusDelegate: [{ type: Input }],
        type: [{ type: Input }],
        styleClass: [{ type: Input }],
        onChangeFilter: [{ type: Output }],
        validations: [{ type: Input }],
        depends: [{ type: Input }],
        dependencyTerms: [{ type: Input }]
    };
    return DynamicDropdownComponent;
}());
export { DynamicDropdownComponent };
if (false) {
    /** @type {?} */
    DynamicDropdownComponent.prototype.ValueComparator;
    /** @type {?} */
    DynamicDropdownComponent.prototype.field;
    /** @type {?} */
    DynamicDropdownComponent.prototype.disabled;
    /** @type {?} */
    DynamicDropdownComponent.prototype.options;
    /** @type {?} */
    DynamicDropdownComponent.prototype.label;
    /** @type {?} */
    DynamicDropdownComponent.prototype.placeholder;
    /** @type {?} */
    DynamicDropdownComponent.prototype.isMultiple;
    /** @type {?} */
    DynamicDropdownComponent.prototype.context;
    /** @type {?} */
    DynamicDropdownComponent.prototype.contextTerms;
    /** @type {?} */
    DynamicDropdownComponent.prototype.formControlRef;
    /** @type {?} */
    DynamicDropdownComponent.prototype.formGroup;
    /** @type {?} */
    DynamicDropdownComponent.prototype.default;
    /** @type {?} */
    DynamicDropdownComponent.prototype.contextData;
    /** @type {?} */
    DynamicDropdownComponent.prototype.dataLoadStatusDelegate;
    /** @type {?} */
    DynamicDropdownComponent.prototype.type;
    /** @type {?} */
    DynamicDropdownComponent.prototype.styleClass;
    /** @type {?} */
    DynamicDropdownComponent.prototype.onChangeFilter;
    /** @type {?} */
    DynamicDropdownComponent.prototype.validations;
    /** @type {?} */
    DynamicDropdownComponent.prototype.depends;
    /** @type {?} */
    DynamicDropdownComponent.prototype.dependencyTerms;
    /** @type {?} */
    DynamicDropdownComponent.prototype.isDependsInvalid;
    /** @type {?} */
    DynamicDropdownComponent.prototype.options$;
    /** @type {?} */
    DynamicDropdownComponent.prototype.contextValueChangesSubscription;
    /** @type {?} */
    DynamicDropdownComponent.prototype.selectedType;
    /** @type {?} */
    DynamicDropdownComponent.prototype.tempAssociation;
    /** @type {?} */
    DynamicDropdownComponent.prototype.latestParentValue;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pYy1kcm9wZG93bi5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9jb21tb24tZm9ybS1lbGVtZW50cy8iLCJzb3VyY2VzIjpbImxpYi9keW5hbWljLWRyb3Bkb3duL2R5bmFtaWMtZHJvcGRvd24uY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLE9BQU8sRUFBQyxTQUFTLEVBQUUsS0FBSyxFQUFnQyxNQUFNLEVBQWlCLFlBQVksRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUNsSCxPQUFPLEVBQUMsV0FBVyxFQUFFLFNBQVMsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ3RELE9BQU8sRUFBYSxPQUFPLEVBQStCLEtBQUssRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUU3RSxPQUFPLEVBQUMsR0FBRyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDbkMsT0FBTyxLQUFLLENBQUMsTUFBTSxXQUFXLENBQUM7QUFDL0IsT0FBTyxFQUFDLGVBQWUsRUFBQyxNQUFNLCtCQUErQixDQUFDO0FBRTlEO0lBbUNFO1FBN0JBLG9CQUFlLEdBQUcsZUFBZSxDQUFDO1FBZ0J4QixtQkFBYyxHQUFzQixJQUFJLFlBQVksRUFBRSxDQUFDO1FBSXhELG9CQUFlLEdBQVMsRUFBRSxDQUFDO0lBVXBDLENBQUM7Ozs7O0lBRUQsOENBQVc7Ozs7SUFBWCxVQUFZLE9BQXNCO1FBQWxDLGlCQWFDO1FBWkMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDakIsSUFBSSxDQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7U0FDbkI7UUFDRCxJQUFJLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUU7WUFDdkMsSUFBSSxDQUFDLFFBQVEsR0FBRyxtQkFBQSxDQUFDLG1CQUFBLElBQUksQ0FBQyxPQUFPLEVBQXlDLENBQUMsQ0FDckUsSUFBSSxDQUFDLGNBQWMsRUFDbkIsSUFBSSxDQUFDLE9BQU8sRUFDWixJ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QUMsVUFBVSxDQUFDO2lCQUMxRTtxQkFBTztvQkFDTixPQUFPLE1BQU0sQ0FBQztpQkFDZjthQUNGO1NBQ0Y7SUFDSCxDQUFDOzs7Ozs7SUFFRCx1REFBb0I7Ozs7O0lBQXBCLFVBQXFCLE1BQU0sRUFBRSxNQUFPO0lBRXBDLENBQUM7O2dCQTFNRixTQUFTLFNBQUM7b0JBQ1QsUUFBUSxFQUFFLHFCQUFxQjtvQkFDL0Iscy9HQUFnRDs7aUJBRWpEOzs7Ozt3QkFHRSxLQUFLOzJCQUNMLEtBQUs7MEJBQ0wsS0FBSzt3QkFDTCxLQUFLOzhCQUNMLEtBQUs7NkJBQ0wsS0FBSzswQkFDTCxLQUFLOytCQUNMLEtBQUs7aUNBQ0wsS0FBSzs0QkFDTCxLQUFLOzBCQUNMLEtBQUs7OEJBQ0wsS0FBSzt5Q0FDTCxLQUFLO3VCQUNMLEtBQUs7NkJBQ0wsS0FBSztpQ0FDTCxNQUFNOzhCQUNOLEtBQUs7MEJBRUwsS0FBSztrQ0FDTCxLQUFLOztJQWlMUiwrQkFBQztDQUFBLEFBM01ELElBMk1DO1NBdE1ZLHdCQUF3Qjs7O0lBQ25DLG1EQUFrQzs7SUFDbEMseUNBQW9DOztJQUNwQyw0Q0FBNEI7O0lBQzVCLDJDQUFzQjs7SUFDdEIseUNBQXdCOztJQUN4QiwrQ0FBOEI7O0lBQzlCLDhDQUE4Qjs7SUFDOUIsMkNBQStCOztJQUMvQixnREFBNEI7O0lBQzVCLGtEQUFzQzs7SUFDdEMsNkNBQStCOztJQUMvQiwyQ0FBdUI7O0lBQ3ZCLCtDQUEwQjs7SUFDMUIsMERBQStEOztJQUMvRCx3Q0FBdUI7O0lBQ3ZCLDhDQUE2Qjs7SUFDN0Isa0RBQWlFOztJQUNqRSwrQ0FBMkI7O0lBRTNCLDJDQUFpQzs7SUFDakMsbURBQW9DOztJQUVwQyxvREFBNkI7O0lBRTdCLDRDQUFnRDs7SUFDaEQsbUVBQStDOztJQUMvQyxnREFBa0I7O0lBQ2xCLG1EQUFxQjs7SUFDckIscURBQTBCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtDb21wb25lbnQsIElucHV0LCBPbkNoYW5nZXMsIE9uRGVzdHJveSwgT25Jbml0LCBPdXRwdXQsIFNpbXBsZUNoYW5nZXMsIEV2ZW50RW1pdHRlcn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge0Zvcm1Db250cm9sLCBGb3JtR3JvdXB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7T2JzZXJ2YWJsZSwgU3ViamVjdCwgU3Vic2NyaXB0aW9uLCBjb21iaW5lTGF0ZXN0LCBtZXJnZX0gZnJvbSAncnhqcyc7XG5pbXBvcnQge0ZpZWxkQ29uZmlnLCBGaWVsZENvbmZpZ09wdGlvbiwgRmllbGRDb25maWdPcHRpb25zQnVpbGRlciwgRHluYW1pY0ZpZWxkQ29uZmlnT3B0aW9uc0J1aWxkZXJ9IGZyb20gJy4uL2NvbW1vbi1mb3JtLWNvbmZpZyc7XG5pbXBvcnQge3RhcH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0ICogYXMgXyBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHtWYWx1ZUNvbXBhcmF0b3J9IGZyb20gJy4uL3V0aWxpdGllcy92YWx1ZS1jb21wYXJhdG9yJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnc2ItZHluYW1pYy1kcm9wZG93bicsXG4gIHRlbXBsYXRlVXJsOiAnLi9keW5hbWljLWRyb3Bkb3duLmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vZHluYW1pYy1kcm9wZG93bi5jb21wb25lbnQuY3NzJ11cbn0pXG5leHBvcnQgY2xhc3MgRHluYW1pY0Ryb3Bkb3duQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkNoYW5nZXMsIE9uRGVzdHJveSB7XG4gIFZhbHVlQ29tcGFyYXRvciA9IFZhbHVlQ29tcGFyYXRvcjtcbiAgQElucHV0KCkgZmllbGQ6IEZpZWxkQ29uZmlnPFN0cmluZz47XG4gIEBJbnB1dCgpIGRpc2FibGVkPzogYm9vbGVhbjtcbiAgQElucHV0KCkgb3B0aW9uczogYW55O1xuICBASW5wdXQoKSBsYWJlbD86IHN0cmluZztcbiAgQElucHV0KCkgcGxhY2Vob2xkZXI/OiBzdHJpbmc7XG4gIEBJbnB1dCgpIGlzTXVsdGlwbGU/OiBib29sZWFuO1xuICBASW5wdXQoKSBjb250ZXh0PzogRm9ybUNvbnRyb2w7XG4gIEBJbnB1dCgpIGNvbnRleHRUZXJtcz86IGFueTtcbiAgQElucHV0KCkgZm9ybUNvbnRyb2xSZWY/OiBGb3JtQ29udHJvbDtcbiAgQElucHV0KCkgZm9ybUdyb3VwPzogRm9ybUdyb3VwO1xuICBASW5wdXQoKSBkZWZhdWx0PzogYW55O1xuICBASW5wdXQoKSBjb250ZXh0RGF0YTogYW55O1xuICBASW5wdXQoKSBkYXRhTG9hZFN0YXR1c0RlbGVnYXRlOiBTdWJqZWN0PCdMT0FESU5HJyB8ICdMT0FERUQnPjtcbiAgQElucHV0KCkgdHlwZT86IHN0cmluZztcbiAgQElucHV0KCkgc3R5bGVDbGFzcz86IHN0cmluZztcbiAgQE91dHB1dCgpIG9uQ2hhbmdlRmlsdGVyOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgQElucHV0KCkgdmFsaWRhdGlvbnM/OiBhbnk7XG5cbiAgQElucHV0KCkgZGVwZW5kcz86IEZvcm1Db250cm9sW107XG4gIEBJbnB1dCgpIGRlcGVuZGVuY3lUZXJtcz86IGFueSA9IFtdO1xuXG4gIHB1YmxpYyBpc0RlcGVuZHNJbnZhbGlkOiBhbnk7XG5cbiAgb3B0aW9ucyQ/OiBPYnNlcnZhYmxlPEZpZWxkQ29uZmlnT3B0aW9uPGFueT5bXT47XG4gIGNvbnRleHRWYWx1ZUNoYW5nZXNTdWJzY3JpcHRpb24/OiBTdWJzY3JpcHRpb247XG4gIHNlbGVjdGVkVHlwZTogYW55O1xuICB0ZW1wQXNzb2NpYXRpb246IGFueTtcbiAgbGF0ZXN0UGFyZW50VmFsdWU6IHN0cmluZztcbiAgY29uc3RydWN0b3IoKSB7XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLm9wdGlvbnMpIHtcbiAgICAgIHRoaXMub3B0aW9ucyA9IFtdO1xuICAgIH1cbiAgICBpZiAodGhpcy5pc09wdGlvbnNDbG9zdXJlKHRoaXMub3B0aW9ucykpIHtcbiAgICAgIHRoaXMub3B0aW9ucyQgPSAodGhpcy5vcHRpb25zIGFzIER5bmFtaWNGaWVsZENvbmZpZ09wdGlvbnNCdWlsZGVyPGFueT4pKFxuICAgICAgICB0aGlzLmZvcm1Db250cm9sUmVmLFxuICAgICAgICB0aGlzLmRlcGVuZHMsXG4gICAgICAgIHRoaXMuZm9ybUdyb3VwLFxuICAgICAgICAoKSA9PiB0aGlzLmRhdGFMb2FkU3RhdHVzRGVsZWdhdGUubmV4dCgnTE9BRElORycpLFxuICAgICAgICAoKSA9PiB0aGlzLmRhdGFMb2FkU3RhdHVzRGVsZWdhdGUubmV4dCgnTE9BREVEJylcbiAgICAgICkgYXMgYW55O1xuICAgIH1cbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIGlmICghdGhpcy5vcHRpb25zKSB7XG4gICAgICB0aGlzLm9wdGlvbnMgPSBbXTtcbiAgICB9XG5cbiAgICAvLyBpZiAodGhpcy5jb250ZXh0KSB7XG4gICAgICAvLyB0aGlzLmNvbnRleHRWYWx1ZUNoYW5nZXNTdWJzY3JpcHRpb24gPSB0aGlzLmNvbnRleHQudmFsdWVDaGFuZ2VzLnBpcGUoXG4gICAgICAvLyAgIHRhcCgoKSA9PiB7XG4gICAgICAvLyAgICAgdGhpcy5mb3JtQ29udHJvbFJlZi5wYXRjaFZhbHVlKG51bGwpO1xuICAgICAgLy8gICB9KVxuICAgICAgLy8gKS5zdWJzY3JpYmUoKTtcbiAgICAvLyB9XG5cbiAgICB0aGlzLmRhdGFMb2FkU3RhdHVzRGVsZWdhdGUuc3Vic2NyaWJlKFxuICAgICAgY29uc29sZS5sb2dcbiAgICApO1xuXG4gICAgaWYgKHRoaXMuZmllbGQgJiYgdGhpcy5maWVsZC5yYW5nZSkge1xuICAgICAgdGhpcy5vcHRpb25zID0gdGhpcy5maWVsZC5yYW5nZTtcbiAgICB9IGVsc2UgaWYgKF8uaXNFbXB0eSh0aGlzLm9wdGlvbnMpICYmIF8uaXNFbXB0eSh0aGlzLmZpZWxkLnJhbmdlKSAmJiB0aGlzLmRlZmF1bHQpIHtcbiAgICAgIHRoaXMuZmllbGQucmFuZ2UgPSBbXTtcbiAgICAgIHRoaXMuZmllbGQucmFuZ2UucHVzaCh0aGlzLmRlZmF1bHQpO1xuICAgIH1cblxuXG4gICAgaWYgKCFfLmlzRW1wdHkodGhpcy5kZXBlbmRzKSkge1xuICAgICB0aGlzLmNvbnRleHRWYWx1ZUNoYW5nZXNTdWJzY3JpcHRpb24gPSAgbWVyZ2UoLi4uXy5tYXAodGhpcy5kZXBlbmRzLCBkZXBlbmQgPT4gZGVwZW5kLnZhbHVlQ2hhbmdlcykpLnBpcGUoXG4gICAgICB0YXAoKHZhbHVlOiBhbnkpID0+IHtcbiAgICAgICAgdGhpcy5sYXRlc3RQYXJlbnRWYWx1ZSA9IHZhbHVlO1xuICAgICAgICB0aGlzLmlzRGVwZW5kc0ludmFsaWQgPSBfLmluY2x1ZGVzKF8ubWFwKHRoaXMuZGVwZW5kcywgZGVwZW5kID0+IGRlcGVuZC5pbnZhbGlkKSwgdHJ1ZSk7XG4gICAgICAgIHRoaXMuZm9ybUNvbnRyb2xSZWYucGF0Y2hWYWx1ZShudWxsKTtcbiAgICAgIH0pXG4gICAgICApLnN1YnNjcmliZSgpO1xuXG4gICAgICB0aGlzLmlzRGVwZW5kc0ludmFsaWQgPSBfLmluY2x1ZGVzKF8ubWFwKHRoaXMuZGVwZW5kcywgZGVwZW5kID0+IGRlcGVuZC5pbnZhbGlkKSwgdHJ1ZSk7XG4gICAgfVxuXG5cbiAgICBpZiAodGhpcy5pc09wdGlvbnNDbG9zdXJlKHRoaXMub3B0aW9ucykpIHtcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcbiAgICAgIHRoaXMub3B0aW9ucyQgPSAodGhpcy5vcHRpb25zIGFzIER5bmFtaWNGaWVsZENvbmZpZ09wdGlvbnNCdWlsZGVyPGFueT4pKHRoaXMuZm9ybUNvbnRyb2xSZWYsIHRoaXMuZGVwZW5kcywgdGhpcy5mb3JtR3JvdXAsICgpID0+IHRoaXMuZGF0YUxvYWRTdGF0dXNEZWxlZ2F0ZS5uZXh0KCdMT0FESU5HJyksICgpID0+IHRoaXMuZGF0YUxvYWRTdGF0dXNEZWxlZ2F0ZS5uZXh0KCdMT0FERUQnKSkgYXMgYW55O1xuICAgIH1cbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmNvbnRleHRWYWx1ZUNoYW5nZXNTdWJzY3JpcHRpb24pIHtcbiAgICAgIHRoaXMuY29udGV4dFZhbHVlQ2hhbmdlc1N1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIH1cbiAgfVxuXG4gIGlzT3B0aW9uc0FycmF5KG9wdGlvbnM6IGFueSkge1xuICAgIHJldHVybiBBcnJheS5pc0FycmF5KG9wdGlvbnMpO1xuXG4gIH1cblxuICBpc09wdGlvbnNDbG9zdXJlKG9wdGlvbnM6IGFueSkge1xuICAgIHJldHVybiB0eXBlb2Ygb3B0aW9ucyA9PT0gJ2Z1bmN0aW9uJztcbiAgfVxuXG4gIGlzT3B0aW9uc01hcChpbnB1dDogYW55KSB7XG4gICAgcmV0dXJuICFBcnJheS5pc0FycmF5KGlucHV0KSAmJiB0eXBlb2YgaW5wdXQgPT09ICdvYmplY3QnO1xuICB9XG5cbiAgaXNPcHRpb25zQXJyYXlNYXAoaW5wdXQ6IGFueSkge1xuICAgIHJldHVybiBBcnJheS5pc0FycmF5KGlucHV0KSAmJiB0eXBlb2YgaW5wdXRbMF0gPT09ICdvYmplY3QnO1xuICB9XG5cbiAgb25DaGFuZ2VGYWNldCgkZXZlbnQpIHtcbiAgICBjb25zdCBzZWxlY3RlZE9iamVjdCA9IHRoaXMub3B0aW9ucy5kYXRhWyRldmVudC5jdXJyZW50VGFyZ2V0Lm9wdGlvbnMuc2VsZWN0ZWRJbmRleCAtIDFdO1xuICAgIGNvbnN0IGVtaXRQYXlsb2FkID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh0aGlzLm9wdGlvbnMpKTtcbiAgICBlbWl0UGF5bG9hZFsnZGF0YSddID0gc2VsZWN0ZWRPYmplY3Q7XG4gICAgZW1pdFBheWxvYWRbJ3NlbGVjdGVkTGFiZWwnXSA9IHNlbGVjdGVkT2JqZWN0LmxhYmVsO1xuICAgIGVtaXRQYXlsb2FkWydzZWxlY3RlZFZhbHVlJ10gPSBzZWxlY3RlZE9iamVjdC52YWx1ZTtcbiAgICB0aGlzLm9uQ2hhbmdlRmlsdGVyLmVtaXQoZW1pdFBheWxvYWQpO1xuICB9XG5cbiAgZmV0Y2hBc3NvY2lhdGlvbnMoKSB7XG4gICAgLy8gJiYgdGhpcy5jb250ZXh0LnZhbHVlICYmIHRoaXMuZmllbGQuYXNzb2NpYXRpb25cbiAgICBpZiAoIV8uaXNFbXB0eSh0aGlzLmRlcGVuZHMpKSB7XG4gICAgICBjb25zdCBmaWx0ZXJlZFRlcm0gPSBfLmZpbmQodGhpcy5kZXBlbmRlbmN5VGVybXMsIHRlcm1zID0+IHtcbiAgICAgICAgcmV0dXJuICFfLmlzRW1wdHkodGhpcy5maWVsZC5vdXRwdXQpID9cbiAgICAgICAgXy5pbmNsdWRlcyh0aGlzLmdldFBhcmVudFZhbHVlKCksIHRlcm1zW3RoaXMuZmllbGQub3V0cHV0XSkgOlxuICAgICAgICBfLmluY2x1ZGVzKHRoaXMuZ2V0UGFyZW50VmFsdWUoKSwgdGVybXMubmFtZSkgO1xuICAgICAgfSk7XG4gICAgICBpZiAoZmlsdGVyZWRUZXJtKSB7XG4gICAgICAgIHRoaXMudGVtcEFzc29jaWF0aW9uID0gIF8uZmlsdGVyKGZpbHRlcmVkVGVybS5hc3NvY2lhdGlvbnMsIGFzc29jaWF0aW9uID0+IHtcbiAgICAgICAgICByZXR1cm4gKHRoaXMuZmllbGQuc291cmNlQ2F0ZWdvcnkpID9cbiAgICAgICAgICAoYXNzb2NpYXRpb24uY2F0ZWdvcnkgPT09IHRoaXMuZmllbGQuc291cmNlQ2F0ZWdvcnkpIDpcbiAgICAgICAgICBhc3NvY2lhdGlvbi5jYXRlZ29yeSA9PT0gdGhpcy5maWVsZC5jb2RlO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHRoaXMudGVtcEFzc29jaWF0aW9uO1xuICAgICAgfSBlbHNlICB7XG4gICAgICAgIHJldHVybiB0aGlzLm9wdGlvbnM7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLm9wdGlvbnM7XG4gICAgfVxuICB9XG5cblxuICBnZXRQYXJlbnRWYWx1ZSgpIHtcbiAgICByZXR1cm4gdGhpcy5sYXRlc3RQYXJlbnRWYWx1ZSB8fCBfLmNvbXBhY3QoXy5tYXAodGhpcy5kZXBlbmRzLCAndmFsdWUnKSk7XG4gIH1cblxuICBnZXRPcHRpb25WYWx1ZUZvclRlcm1zKG9wdGlvbikge1xuICAgIGlmICh0aGlzLmZpZWxkLm91dHB1dCkge1xuICAgICAgaWYgKHRoaXMuZmllbGQuZGF0YVR5cGUgPT09ICdsaXN0Jykge1xuICAgICAgICByZXR1cm4gW29wdGlvblt0aGlzLmZpZWxkLm91dHB1dF1dO1xuICAgICAgfVxuICAgICAgcmV0dXJuIG9wdGlvblt0aGlzLmZpZWxkLm91dHB1dF07XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLmZpZWxkLmRhdGFUeXBlID09PSAnbGlzdCcgPyBbb3B0aW9uLm5hbWVdIDogb3B0aW9uLm5hbWU7XG4gICAgfVxuICB9XG5cbiAgZ2V0T3B0aW9uVmFsdWVGb3JSYW5nZShvcHRpb24sIG9wdGlvbnNUeXBlKSB7XG4gICAgaWYgKHRoaXMuZmllbGQub3V0cHV0KSB7XG4gICAgICBpZiAodGhpcy5maWVsZC5kYXRhVHlwZSA9PT0gJ2xpc3QnKSB7XG4gICAgICAgIGlmIChvcHRpb25zVHlwZSA9PT0gJ21hcCcgfHwgb3B0aW9uc1R5cGUgPT09ICdjbG9zdXJlJykge1xuICAgICAgICAgIHJldHVybiBbb3B0aW9uW3RoaXMuZmllbGQub3V0cHV0XV0gfHwgW29wdGlvbi52YWx1ZV0gfHwgW29wdGlvbi5pZGVudGlmaWVyXSB8fCBbb3B0aW9uLm5hbWVdIHx8IFtvcHRpb24ubGFiZWxdO1xuICAgICAgICB9IGVsc2UgIHtcbiAgICAgICAgICByZXR1cm4gW29wdGlvbl07XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChvcHRpb25zVHlwZSA9PT0gJ21hcCcgfHwgb3B0aW9uc1R5cGUgPT09ICdjbG9zdXJlJykge1xuICAgICAgICAgIHJldHVybiBvcHRpb25bdGhpcy5maWVsZC5vdXRwdXRdIHx8IG9wdGlvbi52YWx1ZSB8fCBvcHRpb24uaWRlbnRpZmllciB8fCBvcHRpb24ubmFtZSB8fCBvcHRpb24ubGFiZWw7XG4gICAgICAgIH0gZWxzZSAge1xuICAgICAgICAgIHJldHVybiBvcHRpb247XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHRoaXMuZmllbGQuZGF0YVR5cGUgPT09ICdsaXN0Jykge1xuICAgICAgICBpZiAob3B0aW9uc1R5cGUgPT09ICdtYXAnIHx8IG9wdGlvbnNUeXBlID09PSAnY2xvc3VyZScpIHtcbiAgICAgICAgICByZXR1cm4gW29wdGlvbi52YWx1ZV0gfHwgW29wdGlvbi5pZGVudGlmaWVyXSB8fCBbb3B0aW9uLm5hbWVdIHx8IFtvcHRpb24ubGFiZWxdO1xuICAgICAgICB9IGVsc2UgIHtcbiAgICAgICAgICByZXR1cm4gW29wdGlvbl07XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChvcHRpb25zVHlwZSA9PT0gJ21hcCcgfHwgb3B0aW9uc1R5cGUgPT09ICdjbG9zdXJlJykge1xuICAgICAgICAgIHJldHVybiAgb3B0aW9uLm5hbWUgfHwgb3B0aW9uLmxhYmVsIHx8IG9wdGlvbi52YWx1ZSB8fCBvcHRpb24uaWRlbnRpZmllcjtcbiAgICAgICAgfSBlbHNlICB7XG4gICAgICAgICAgcmV0dXJuIG9wdGlvbjtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGNvbnZlcnRPcHRpb25Ub0FycmF5KG9wdGlvbiwgb3V0cHV0Pykge1xuXG4gIH1cbn1cbiJdfQ==